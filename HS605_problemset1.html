<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>hs605_problemset1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="HS605_problemset1_files/libs/clipboard/clipboard.min.js"></script>
<script src="HS605_problemset1_files/libs/quarto-html/quarto.js"></script>
<script src="HS605_problemset1_files/libs/quarto-html/popper.min.js"></script>
<script src="HS605_problemset1_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="HS605_problemset1_files/libs/quarto-html/anchor.min.js"></script>
<link href="HS605_problemset1_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="HS605_problemset1_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="HS605_problemset1_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="HS605_problemset1_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="HS605_problemset1_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#section" id="toc-section" class="nav-link active" data-scroll-target="#section">;</a></li>
  <li><a href="#hw-problem-set-1" id="toc-hw-problem-set-1" class="nav-link" data-scroll-target="#hw-problem-set-1">HW Problem Set 1</a></li>
  <li><a href="#fall-2025-dspa-hs650" id="toc-fall-2025-dspa-hs650" class="nav-link" data-scroll-target="#fall-2025-dspa-hs650">Fall 2025, DSPA (HS650)</a></li>
  <li><a href="#name-charlie-jordan" id="toc-name-charlie-jordan" class="nav-link" data-scroll-target="#name-charlie-jordan">Name: Charlie Jordan</a></li>
  <li><a href="#sid-0434" id="toc-sid-0434" class="nav-link" data-scroll-target="#sid-0434">SID: 0434</a></li>
  <li><a href="#umich-e-mail-cejordanumich.edu" id="toc-umich-e-mail-cejordanumich.edu" class="nav-link" data-scroll-target="#umich-e-mail-cejordanumich.edu">UMich E-mail: cejordan@umich.edu</a></li>
  <li><a href="#i-certify-that-the-following-paper-represents-my-own-independent-work-and-conforms-with-the-guidelines-of-academic-honesty-described-in-the-umich-student-handbook." id="toc-i-certify-that-the-following-paper-represents-my-own-independent-work-and-conforms-with-the-guidelines-of-academic-honesty-described-in-the-umich-student-handbook." class="nav-link" data-scroll-target="#i-certify-that-the-following-paper-represents-my-own-independent-work-and-conforms-with-the-guidelines-of-academic-honesty-described-in-the-umich-student-handbook.">I certify that the following paper represents my own independent work and conforms with the guidelines of academic honesty described in the UMich student handbook.</a></li>
  <li><a href="#remember-you-are-allowed-and-encouraged-to-discuss-on-a-conceptual-level-the-problems-with-your-class-mates-however-this-can-not-involve-the-exchange-of-actual-code-printouts-solutions-e-mails-or-other-explicit-electronic-or-paper-handouts." id="toc-remember-you-are-allowed-and-encouraged-to-discuss-on-a-conceptual-level-the-problems-with-your-class-mates-however-this-can-not-involve-the-exchange-of-actual-code-printouts-solutions-e-mails-or-other-explicit-electronic-or-paper-handouts." class="nav-link" data-scroll-target="#remember-you-are-allowed-and-encouraged-to-discuss-on-a-conceptual-level-the-problems-with-your-class-mates-however-this-can-not-involve-the-exchange-of-actual-code-printouts-solutions-e-mails-or-other-explicit-electronic-or-paper-handouts.">Remember you are allowed and encouraged to discuss, on a conceptual level, the problems with your class mates, however, this can not involve the exchange of actual code, printouts, solutions, e-mails or other explicit electronic or paper handouts.</a></li>
  <li><a href="#homeworks-and-projects" id="toc-homeworks-and-projects" class="nav-link" data-scroll-target="#homeworks-and-projects">Homeworks and Projects</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content"><div class="quarto-title-block"><div class="quarto-title-tools-only"><h1></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>




<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section">;</h2>
</section>
<section id="hw-problem-set-1" class="level1">
<h1>HW Problem Set 1</h1>
</section>
<section id="fall-2025-dspa-hs650" class="level1">
<h1>Fall 2025, DSPA (HS650)</h1>
</section>
<section id="name-charlie-jordan" class="level1">
<h1>Name: Charlie Jordan</h1>
</section>
<section id="sid-0434" class="level1">
<h1>SID: 0434</h1>
</section>
<section id="umich-e-mail-cejordanumich.edu" class="level1">
<h1>UMich E-mail: cejordan@umich.edu</h1>
</section>
<section id="i-certify-that-the-following-paper-represents-my-own-independent-work-and-conforms-with-the-guidelines-of-academic-honesty-described-in-the-umich-student-handbook." class="level1">
<h1>I certify that the following paper represents my own independent work and conforms with the guidelines of academic honesty described in the UMich student handbook.</h1>
</section>
<section id="remember-you-are-allowed-and-encouraged-to-discuss-on-a-conceptual-level-the-problems-with-your-class-mates-however-this-can-not-involve-the-exchange-of-actual-code-printouts-solutions-e-mails-or-other-explicit-electronic-or-paper-handouts." class="level1">
<h1>Remember you are allowed and encouraged to discuss, on a conceptual level, the problems with your class mates, however, this can not involve the exchange of actual code, printouts, solutions, e-mails or other explicit electronic or paper handouts.</h1>
</section>
<section id="homeworks-and-projects" class="level1">
<h1>Homeworks and Projects</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Problem 1.1: ultra-robust SOCR HPI loader (fixed pipes) ---</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>need <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"rvest"</span>,<span class="st">"xml2"</span>,<span class="st">"stringr"</span>,<span class="st">"readr"</span>,<span class="st">"dplyr"</span>,<span class="st">"tidyr"</span>,<span class="st">"janitor"</span>,<span class="st">"purrr"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>inst <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(need, <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(inst)) <span class="fu">install.packages</span>(inst, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(rvest); <span class="fu">library</span>(xml2); <span class="fu">library</span>(stringr); <span class="fu">library</span>(readr)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr); <span class="fu">library</span>(tidyr); <span class="fu">library</span>(janitor); <span class="fu">library</span>(purrr)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>url_base <span class="ot">&lt;-</span> <span class="st">"https://wiki.socr.umich.edu/index.php/SOCR_Data_Dinov_010309_HousingPriceIndex"</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- helpers ----------</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>parse_rows <span class="ot">&lt;-</span> <span class="cf">function</span>(lines) {</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  pat <span class="ot">&lt;-</span> <span class="st">"^[A-Za-z][A-Za-z_ ]*</span><span class="sc">\\</span><span class="st">s+(19|20)</span><span class="sc">\\</span><span class="st">d{2}</span><span class="sc">\\</span><span class="st">s+[-+]?</span><span class="sc">\\</span><span class="st">d*</span><span class="sc">\\</span><span class="st">.?</span><span class="sc">\\</span><span class="st">d+</span><span class="sc">\\</span><span class="st">s+[-+]?</span><span class="sc">\\</span><span class="st">d*</span><span class="sc">\\</span><span class="st">.?</span><span class="sc">\\</span><span class="st">d+</span><span class="sc">\\</span><span class="st">s+[A-Za-z_]+</span><span class="sc">\\</span><span class="st">s+[-+]?</span><span class="sc">\\</span><span class="st">d*</span><span class="sc">\\</span><span class="st">.?</span><span class="sc">\\</span><span class="st">d+%?</span><span class="sc">\\</span><span class="st">s+[-+]?</span><span class="sc">\\</span><span class="st">d*</span><span class="sc">\\</span><span class="st">.?</span><span class="sc">\\</span><span class="st">d+%?$"</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  dl <span class="ot">&lt;-</span> lines[<span class="fu">str_detect</span>(lines, pat)]</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(dl)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  dl <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(dl, <span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span>, <span class="st">" "</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  txt <span class="ot">&lt;-</span> <span class="fu">paste</span>(dl, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_table2</span>(</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    txt,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">"state"</span>,<span class="st">"year"</span>,<span class="st">"hpi"</span>,<span class="st">"ur"</span>,<span class="st">"region"</span>,<span class="st">"pop"</span>,<span class="st">"percent"</span>),</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_types =</span> <span class="fu">cols</span>(</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">state  =</span> <span class="fu">col_character</span>(),</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">year   =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">hpi    =</span> <span class="fu">col_double</span>(),</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">ur     =</span> <span class="fu">col_double</span>(),</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">region =</span> <span class="fu">col_character</span>(),</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop     =</span> <span class="fu">col_character</span>(),</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">percent =</span> <span class="fu">col_character</span>()</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop     =</span> <span class="fu">as.numeric</span>(<span class="fu">str_replace</span>(pop, <span class="st">"%"</span>,<span class="st">""</span>)),</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">percent =</span> <span class="fu">as.numeric</span>(<span class="fu">str_replace</span>(percent, <span class="st">"%"</span>,<span class="st">""</span>))</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_names</span>()</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>pick_best_table <span class="ot">&lt;-</span> <span class="cf">function</span>(tabs) {</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tabs)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  tabs <span class="ot">&lt;-</span> <span class="fu">compact</span>(<span class="fu">lapply</span>(tabs, janitor<span class="sc">::</span>clean_names))</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tabs)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    nm <span class="ot">&lt;-</span> <span class="fu">names</span>(df)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1000</span> <span class="sc">*</span> <span class="fu">sum</span>(<span class="fu">c</span>(<span class="st">"state"</span>,<span class="st">"year"</span>,<span class="st">"hpi"</span>) <span class="sc">%in%</span> nm) <span class="sc">+</span> <span class="fu">nrow</span>(df)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  tabs[[ <span class="fu">which.max</span>(<span class="fu">vapply</span>(tabs, score, <span class="fu">numeric</span>(<span class="dv">1</span>))) ]]</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="co"># A) direct HTML tables</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>try_tables <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> <span class="fu">read_html</span>(url)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  tables <span class="ot">&lt;-</span> <span class="fu">html_table</span>(pg, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  best <span class="ot">&lt;-</span> <span class="fu">pick_best_table</span>(tables)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(best)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  nm <span class="ot">&lt;-</span> <span class="fu">names</span>(best)</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  ren <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state"</span>   <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^state$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year"</span>    <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^year$"</span>,  nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hpi"</span>     <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^hpi"</span>,    nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ur"</span>      <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^ur$|unemployment"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"region"</span>  <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^region$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pop"</span>     <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^pop"</span>,     nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"percent"</span> <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^percent$|^perc"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  ren <span class="ot">&lt;-</span> ren[<span class="sc">!</span><span class="fu">is.na</span>(ren)]</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">unname</span>(ren), <span class="fu">names</span>(best)); keep <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(idx)</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(best)[idx[keep]] <span class="ot">&lt;-</span> <span class="fu">names</span>(ren)[keep]</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"state"</span>,<span class="st">"year"</span>,<span class="st">"hpi"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(best))) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  best <span class="sc">%&gt;%</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">year    =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.integer</span>(year)),</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">hpi     =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(hpi)),</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">ur      =</span> <span class="cf">if</span> (<span class="st">"ur"</span> <span class="sc">%in%</span> <span class="fu">names</span>(.)) <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(ur)) <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop     =</span> <span class="cf">if</span> (<span class="st">"pop"</span> <span class="sc">%in%</span> <span class="fu">names</span>(.)) <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(<span class="fu">str_replace</span>(pop, <span class="st">"%"</span>,<span class="st">""</span>))) <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">percent =</span> <span class="cf">if</span> (<span class="st">"percent"</span> <span class="sc">%in%</span> <span class="fu">names</span>(.)) <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(<span class="fu">str_replace</span>(percent, <span class="st">"%"</span>,<span class="st">""</span>))) <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">region  =</span> <span class="cf">if</span> (<span class="st">"region"</span> <span class="sc">%in%</span> <span class="fu">names</span>(.)) <span class="fu">as.character</span>(region) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">any_of</span>(<span class="fu">c</span>(<span class="st">"state"</span>,<span class="st">"year"</span>,<span class="st">"hpi"</span>,<span class="st">"ur"</span>,<span class="st">"region"</span>,<span class="st">"pop"</span>,<span class="st">"percent"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(state, year)</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="co"># B) pre/code blocks</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>try_pre_blocks <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> <span class="fu">read_html</span>(url)</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>  blocks <span class="ot">&lt;-</span> <span class="fu">html_elements</span>(pg, <span class="st">"pre, code, .mw-highlight, .mw-code"</span>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(blocks)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>  text_all <span class="ot">&lt;-</span> <span class="fu">html_text2</span>(blocks)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>  text_join <span class="ot">&lt;-</span> <span class="fu">paste</span>(text_all, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">str_split</span>(text_join, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[[<span class="dv">1</span>]]</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines)</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_rows</span>(lines)</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a><span class="co"># C) raw edit view</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>try_edit_raw <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="fu">paste0</span>(url, <span class="st">"?action=edit"</span>))</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>  tx <span class="ot">&lt;-</span> <span class="fu">html_elements</span>(pg, <span class="st">"textarea#wpTextbox1"</span>)</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tx)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>  raw <span class="ot">&lt;-</span> <span class="fu">html_text2</span>(tx[[<span class="dv">1</span>]])</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">str_split</span>(raw, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[[<span class="dv">1</span>]]</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines)</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_rows</span>(lines)</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a><span class="co"># D) printable view</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>try_printable <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="fu">paste0</span>(url, <span class="st">"?printable=yes"</span>))</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">html_element</span>(pg, <span class="st">"#mw-content-text"</span>)</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(el)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>  txt <span class="ot">&lt;-</span> <span class="fu">html_text2</span>(el)</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">str_split</span>(txt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[[<span class="dv">1</span>]]</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines)</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_rows</span>(lines)</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Run strategies in order</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>hpi <span class="ot">&lt;-</span> <span class="fu">try_tables</span>(url_base)</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(hpi)) hpi <span class="ot">&lt;-</span> <span class="fu">try_pre_blocks</span>(url_base)</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(hpi)) hpi <span class="ot">&lt;-</span> <span class="fu">try_edit_raw</span>(url_base)</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(hpi)) hpi <span class="ot">&lt;-</span> <span class="fu">try_printable</span>(url_base)</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(hpi) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(hpi) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(hpi)) {</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Could not locate the data on the page. If campus proxy rewrites pages, copy the data block into a text file and read with readr::read_table2()."</span>)</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a><span class="co"># --------- Long -&gt; Wide ---------</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>wide_hpi <span class="ot">&lt;-</span> hpi <span class="sc">%&gt;%</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols     =</span> state,</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from  =</span> year,</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(hpi), <span class="fu">c</span>(<span class="st">"state"</span>,<span class="st">"year"</span>))),</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue  =</span> <span class="st">"{.value}{year}"</span></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a><span class="co"># --------- Wide -&gt; Long ---------</span></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>long_back <span class="ot">&lt;-</span> wide_hpi <span class="sc">%&gt;%</span></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span>state,</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>,<span class="st">"year"</span>),</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"^(.*?)(</span><span class="sc">\\</span><span class="st">d{4})$"</span>,</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_drop_na =</span> <span class="cn">TRUE</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.integer</span>(year)) <span class="sc">%&gt;%</span></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(state, year)</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a><span class="co"># Checks &amp; peeks</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(long_back<span class="sc">$</span>state) <span class="sc">==</span> dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(hpi<span class="sc">$</span>state))</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(hpi, <span class="dv">12</span>)); <span class="fu">print</span>(<span class="fu">head</span>(wide_hpi, <span class="dv">3</span>)); <span class="fu">print</span>(<span class="fu">head</span>(long_back, <span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 7
   state    year   hpi    ur region   pop percent
   &lt;chr&gt;   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;   &lt;dbl&gt;
 1 Alabama  2000  204.   4.5 South   4452   0.122
 2 Alabama  2001  215.   5.3 South   4452   0.082
 3 Alabama  2002  222.   5.4 South   4452   0.085
 4 Alabama  2003  230.   5.5 South   4452   0.098
 5 Alabama  2004  242.   5.2 South   4452   0.173
 6 Alabama  2005  265.   4   South   4452   0.173
 7 Alabama  2006  284.   3.5 South   4631   0.173
 8 Alaska   2000  170.   6.7 West     628   0.046
 9 Alaska   2001  179.   6.4 West     628   0.031
10 Alaska   2002  188.   7.1 West     628   0.028
11 Alaska   2003  204    7.7 West     628   0.057
12 Alaska   2004  225    7.4 West     628   0.13 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 36
  state   hpi2000 hpi2001 hpi2002 hpi2003 hpi2004 hpi2005 hpi2006 ur2000 ur2001
  &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 Alabama    204.    215.    222.    230.    242.    265.    284.    4.5    5.3
2 Alaska     170.    179.    188.    204     225     258.    274.    6.7    6.4
3 Arizona    207.    220.    233.    250.    291.    395.    433.    4      4.7
# ℹ 26 more variables: ur2002 &lt;dbl&gt;, ur2003 &lt;dbl&gt;, ur2004 &lt;dbl&gt;, ur2005 &lt;dbl&gt;,
#   ur2006 &lt;dbl&gt;, region2000 &lt;chr&gt;, region2001 &lt;chr&gt;, region2002 &lt;chr&gt;,
#   region2003 &lt;chr&gt;, region2004 &lt;chr&gt;, region2005 &lt;chr&gt;, region2006 &lt;chr&gt;,
#   pop2000 &lt;dbl&gt;, pop2001 &lt;dbl&gt;, pop2002 &lt;dbl&gt;, pop2003 &lt;dbl&gt;, pop2004 &lt;dbl&gt;,
#   pop2005 &lt;dbl&gt;, pop2006 &lt;dbl&gt;, percent2000 &lt;dbl&gt;, percent2001 &lt;dbl&gt;,
#   percent2002 &lt;dbl&gt;, percent2003 &lt;dbl&gt;, percent2004 &lt;dbl&gt;, percent2005 &lt;dbl&gt;,
#   percent2006 &lt;dbl&gt;</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 7
   state    year   hpi    ur region   pop percent
   &lt;chr&gt;   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;   &lt;dbl&gt;
 1 Alabama  2000  204.   4.5 South   4452   0.122
 2 Alabama  2001  215.   5.3 South   4452   0.082
 3 Alabama  2002  222.   5.4 South   4452   0.085
 4 Alabama  2003  230.   5.5 South   4452   0.098
 5 Alabama  2004  242.   5.2 South   4452   0.173
 6 Alabama  2005  265.   4   South   4452   0.173
 7 Alabama  2006  284.   3.5 South   4631   0.173
 8 Alaska   2000  170.   6.7 West     628   0.046
 9 Alaska   2001  179.   6.4 West     628   0.031
10 Alaska   2002  188.   7.1 West     628   0.028
11 Alaska   2003  204    7.7 West     628   0.057
12 Alaska   2004  225    7.4 West     628   0.13 </code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Problem 1.2 (Ultra-robust loader + analysis) ---</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>need <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"rvest"</span>,<span class="st">"xml2"</span>,<span class="st">"stringr"</span>,<span class="st">"readr"</span>,<span class="st">"dplyr"</span>,<span class="st">"tidyr"</span>,<span class="st">"janitor"</span>,<span class="st">"purrr"</span>,<span class="st">"ggplot2"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>inst <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(need, <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(inst)) <span class="fu">install.packages</span>(inst, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(rvest); <span class="fu">library</span>(xml2); <span class="fu">library</span>(stringr); <span class="fu">library</span>(readr)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr); <span class="fu">library</span>(tidyr); <span class="fu">library</span>(janitor); <span class="fu">library</span>(purrr); <span class="fu">library</span>(ggplot2)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>url_base <span class="ot">&lt;-</span> <span class="st">"https://wiki.socr.umich.edu/index.php/SOCR_Data_Oct2009_ID_NI"</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- helpers ----------</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>pick_best_table <span class="ot">&lt;-</span> <span class="cf">function</span>(tabs) {</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tabs)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  tabs <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">compact</span>(<span class="fu">lapply</span>(tabs, janitor<span class="sc">::</span>clean_names))</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tabs)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    nm <span class="ot">&lt;-</span> <span class="fu">names</span>(df)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reward presence of expected cols, then rowcount</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    want <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"subject"</span>,<span class="st">"age"</span>,<span class="st">"fs_iq"</span>,<span class="st">"sex"</span>,<span class="st">"l_caudate"</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1000</span> <span class="sc">*</span> <span class="fu">sum</span>(want <span class="sc">%in%</span> nm) <span class="sc">+</span> <span class="fu">nrow</span>(df)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  tabs[[ <span class="fu">which.max</span>(<span class="fu">vapply</span>(tabs, score, <span class="fu">numeric</span>(<span class="dv">1</span>))) ]]</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Try to parse a whitespace table from lines when no HTML table exists</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>parse_from_lines <span class="ot">&lt;-</span> <span class="cf">function</span>(lines) {</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># find a header line that has Subject + Age (and optionally FS_IQ etc.)</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  hdr_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"Subject"</span>, lines, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">grepl</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">bAge</span><span class="sc">\\</span><span class="st">b"</span>, lines, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(hdr_idx)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Take the first header occurrence and consume subsequent non-empty lines</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> hdr_idx[<span class="dv">1</span>]</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  tail_lines <span class="ot">&lt;-</span> lines[(start<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(lines)]</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  tail_lines <span class="ot">&lt;-</span> tail_lines[ <span class="fu">nzchar</span>(<span class="fu">trimws</span>(tail_lines)) ]</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tail_lines)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build colnames by splitting header on whitespace</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>  header_line <span class="ot">&lt;-</span> lines[start]</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">str_split</span>(header_line, <span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>); col_names <span class="ot">&lt;-</span> col_names[col_names <span class="sc">!=</span> <span class="st">""</span>]</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">tolower</span>(col_names)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean typical header variants</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^a-z0-9_]+"</span>, <span class="st">"_"</span>, col_names)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Common canonical names map (be generous)</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>  fixmap <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"subject"</span><span class="ot">=</span><span class="st">"subject"</span>, <span class="st">"subj"</span><span class="ot">=</span><span class="st">"subject"</span>, <span class="st">"id"</span><span class="ot">=</span><span class="st">"subject"</span>,</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span><span class="ot">=</span><span class="st">"age"</span>,</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fs_iq"</span><span class="ot">=</span><span class="st">"fs_iq"</span>, <span class="st">"fsiq"</span><span class="ot">=</span><span class="st">"fs_iq"</span>, <span class="st">"fs-iq"</span><span class="ot">=</span><span class="st">"fs_iq"</span>,</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sex"</span><span class="ot">=</span><span class="st">"sex"</span>, <span class="st">"gender"</span><span class="ot">=</span><span class="st">"sex"</span>,</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"l_caudate"</span><span class="ot">=</span><span class="st">"l_caudate"</span>, <span class="st">"left_caudate"</span><span class="ot">=</span><span class="st">"l_caudate"</span>,</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"r_fusiform_gyrus"</span><span class="ot">=</span><span class="st">"r_fusiform_gyrus"</span>, <span class="st">"right_fusiform_gyrus"</span><span class="ot">=</span><span class="st">"r_fusiform_gyrus"</span>,</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"l_fusiform_gyrus"</span><span class="ot">=</span><span class="st">"l_fusiform_gyrus"</span>, <span class="st">"left_fusiform_gyrus"</span><span class="ot">=</span><span class="st">"l_fusiform_gyrus"</span>,</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"l_insular_cortex"</span><span class="ot">=</span><span class="st">"l_insular_cortex"</span>, <span class="st">"left_insular_cortex"</span><span class="ot">=</span><span class="st">"l_insular_cortex"</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>  cn <span class="ot">&lt;-</span> fixmap[col_names]; cn[<span class="fu">is.na</span>(cn)] <span class="ot">&lt;-</span> col_names</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">make.names</span>(cn, <span class="at">unique =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only lines that look like data rows (start with an ID/Subject and contain numbers)</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>  data_cand <span class="ot">&lt;-</span> tail_lines[ <span class="fu">grepl</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">d"</span>, tail_lines) ]</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(data_cand)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>  data_text <span class="ot">&lt;-</span> <span class="fu">paste</span>(data_cand, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try reading with read_table2 using discovered headers</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    readr<span class="sc">::</span><span class="fu">read_table2</span>(data_text, <span class="at">col_names =</span> col_names, <span class="at">guess_max =</span> <span class="dv">10000</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>),</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(df) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(df) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(df)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>(df)</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy A: direct HTML tables</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>try_tables <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">read_html</span>(url)</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>  tables <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_table</span>(pg, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  best <span class="ot">&lt;-</span> <span class="fu">pick_best_table</span>(tables)</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(best)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>(best)</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy B: pre/code blocks</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>try_pre_blocks <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">read_html</span>(url)</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>  blocks <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_elements</span>(pg, <span class="st">"pre, code, .mw-highlight, .mw-code"</span>)</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(blocks)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>  text_all <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_text2</span>(blocks)</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>  text_join <span class="ot">&lt;-</span> <span class="fu">paste</span>(text_all, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_split</span>(text_join, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)[[<span class="dv">1</span>]]</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines); lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_from_lines</span>(lines)</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy C: raw edit view</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>try_edit_raw <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">read_html</span>(<span class="fu">paste0</span>(url, <span class="st">"?action=edit"</span>))</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>  tx <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_elements</span>(pg, <span class="st">"textarea#wpTextbox1"</span>)</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tx)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>  raw <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_text2</span>(tx[[<span class="dv">1</span>]])</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_split</span>(raw, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)[[<span class="dv">1</span>]]</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines); lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_from_lines</span>(lines)</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy D: printable view</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>try_printable <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">read_html</span>(<span class="fu">paste0</span>(url, <span class="st">"?printable=yes"</span>))</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_element</span>(pg, <span class="st">"#mw-content-text"</span>)</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(el)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>  txt <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_text2</span>(el)</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_split</span>(txt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)[[<span class="dv">1</span>]]</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines); lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_from_lines</span>(lines)</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- load data with fallbacks ----------</span></span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>schizo <span class="ot">&lt;-</span> <span class="fu">try_tables</span>(url_base)</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(schizo)) schizo <span class="ot">&lt;-</span> <span class="fu">try_pre_blocks</span>(url_base)</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(schizo)) schizo <span class="ot">&lt;-</span> <span class="fu">try_edit_raw</span>(url_base)</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(schizo)) schizo <span class="ot">&lt;-</span> <span class="fu">try_printable</span>(url_base)</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(schizo)) {</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Could not parse the Schizophrenia Neuroimaging dataset from the page."</span>)</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- normalize expected columns and types ----------</span></span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>nm <span class="ot">&lt;-</span> <span class="fu">names</span>(schizo)</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Build flexible mapping (only for columns that exist)</span></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>  <span class="st">"subject"</span>           <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^subject$|^id$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>  <span class="st">"age"</span>               <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^age$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fs_iq"</span>             <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^fs[_]?iq$|^fsiq$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sex"</span>               <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^sex$|^gender$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>  <span class="st">"l_caudate"</span>         <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^l[_]?caudate$|left[_ ]?caudate"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_fusiform_gyrus"</span>  <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^r[_]?fusiform[_]?gyrus$|right[_ ]?fusiform"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>  <span class="st">"l_fusiform_gyrus"</span>  <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^l[_]?fusiform[_]?gyrus$|left[_ ]?fusiform"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>  <span class="st">"l_insular_cortex"</span>  <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^l[_]?insular[_]?cortex$|left[_ ]?insular"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> map[<span class="sc">!</span><span class="fu">is.na</span>(map)]</span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a><span class="co"># Base-R rename to avoid tidy-eval traps</span></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">unname</span>(map), <span class="fu">names</span>(schizo))</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>keep <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(idx)</span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(schizo)[idx[keep]] <span class="ot">&lt;-</span> <span class="fu">names</span>(map)[keep]</span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>schizo <span class="ot">&lt;-</span> janitor<span class="sc">::</span><span class="fu">clean_names</span>(schizo)</span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a><span class="co"># Coerce numeric where appropriate (silently)</span></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>num_cols <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"fs_iq"</span>,<span class="st">"l_caudate"</span>,<span class="st">"r_fusiform_gyrus"</span>,<span class="st">"l_fusiform_gyrus"</span>,<span class="st">"l_insular_cortex"</span>),</span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(schizo)</span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(num_cols)) {</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>  schizo[num_cols] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(schizo[num_cols], <span class="cf">function</span>(x) <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(x)))</span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- Problem 1.2 tasks ----------</span></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) First 10 subjects</span></span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(utils<span class="sc">::</span><span class="fu">head</span>(schizo, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 66
   subject   age    dx   sex fs_iq     tbv    gmv    wmv    csf background
     &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;   &lt;int&gt;  &lt;int&gt;  &lt;int&gt;  &lt;int&gt;      &lt;int&gt;
 1      27    14     1     1   118 1663407 654981 840874 167553    8362251
 2     106    15     1     1   116 1583940 527918 851560 204463    8586107
 3     139    14     1     2   107 1299470 550035 614598 134837    8627510
 4     143    15     1     1   107 1535137 599372 780127 155638    8607550
 5     172    15     1     2   107 1431890 593306 695296 143288    8617899
 6     184    15     1     1   100 1578698 822056 546395 210247    8593510
 7     185    14     1     1    94 1453510 534556 730155 188800    8624978
 8     198    10     1     1   114 1650348 608916 860876 180555    8631722
 9     199    15     1     2   107 1288971 479707 668576 140688    8629619
10     402    19     1     1    95 1366346 699476 479998 186872    8624830
# ℹ 56 more variables: l_superior_frontal_gyrus &lt;int&gt;,
#   r_superior_frontal_gyrus &lt;int&gt;, l_middle_frontal_gyrus &lt;int&gt;,
#   r_middle_frontal_gyrus &lt;int&gt;, l_inferior_frontal_gyrus &lt;int&gt;,
#   r_inferior_frontal_gyrus &lt;int&gt;, l_precentral_gyrus &lt;int&gt;,
#   r_precentral_gyrus &lt;int&gt;, l_middle_orbitofrontal_gyrus &lt;int&gt;,
#   r_middle_orbitofrontal_gyrus &lt;int&gt;, l_lateral_orbitofrontal_gyrus &lt;int&gt;,
#   r_lateral_orbitofrontal_gyrus &lt;int&gt;, l_gyrus_rectus &lt;int&gt;, …</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Cases with L_caudate &lt; 160</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>subset_lc_lt_160 <span class="ot">&lt;-</span> schizo <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(l_caudate), l_caudate <span class="sc">&lt;</span> <span class="dv">160</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(subset_lc_lt_160)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 40 × 66
   subject   age    dx   sex fs_iq     tbv    gmv    wmv    csf background
     &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;   &lt;int&gt;  &lt;int&gt;  &lt;int&gt;  &lt;int&gt;      &lt;int&gt;
 1     106    15     1     1   116 1583940 527918 851560 204463    8586107
 2     139    14     1     2   107 1299470 550035 614598 134837    8627510
 3     143    15     1     1   107 1535137 599372 780127 155638    8607550
 4     172    15     1     2   107 1431890 593306 695296 143288    8617899
 5     184    15     1     1   100 1578698 822056 546395 210247    8593510
 6     198    10     1     1   114 1650348 608916 860876 180555    8631722
 7     199    15     1     2   107 1288971 479707 668576 140688    8629619
 8     402    19     1     1    95 1366346 699476 479998 186872    8624830
 9     403    18     1     2   109 1326402 438889 725969 161544    8641084
10     406    18     1     1   125 1503005 711924 595506 195575    8615606
# ℹ 30 more rows
# ℹ 56 more variables: l_superior_frontal_gyrus &lt;int&gt;,
#   r_superior_frontal_gyrus &lt;int&gt;, l_middle_frontal_gyrus &lt;int&gt;,
#   r_middle_frontal_gyrus &lt;int&gt;, l_inferior_frontal_gyrus &lt;int&gt;,
#   r_inferior_frontal_gyrus &lt;int&gt;, l_precentral_gyrus &lt;int&gt;,
#   r_precentral_gyrus &lt;int&gt;, l_middle_orbitofrontal_gyrus &lt;int&gt;,
#   r_middle_orbitofrontal_gyrus &lt;int&gt;, l_lateral_orbitofrontal_gyrus &lt;int&gt;, …</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Sort by L_caudate (descending &amp; ascending)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>desc_lc <span class="ot">&lt;-</span> schizo <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(l_caudate))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>asc_lc  <span class="ot">&lt;-</span> schizo <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">arrange</span>(l_caudate)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(utils<span class="sc">::</span><span class="fu">head</span>(desc_lc, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 66
   subject   age    dx   sex fs_iq     tbv    gmv    wmv    csf background
     &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;   &lt;int&gt;  &lt;int&gt;  &lt;int&gt;  &lt;int&gt;      &lt;int&gt;
 1      27    14     1     1   118 1663407 654981 840874 167553    8362251
 2     782     8     2     1    93 1588573 582006 734277 272290    8594638
 3     130    15     2     1    86 1861991 893907 617597 350487    8016718
 4     426    16     1     1   116 1523045 744793 607825 170427    8583342
 5     102    16     2     2    96 1331777 461919 633299 236559    8630696
 6     428    16     1     1   133 1432033 735130 506333 190569    8610954
 7     183    18     2     1   102 1569413 760825 579644 228944    8236436
 8     185    14     1     1    94 1453510 534556 730155 188800    8624978
 9     104    16     2     1    99 1487886 698476 576154 213256    8598531
10     891    16     1     1   114 1635918 849750 578190 207978    8581983
# ℹ 56 more variables: l_superior_frontal_gyrus &lt;int&gt;,
#   r_superior_frontal_gyrus &lt;int&gt;, l_middle_frontal_gyrus &lt;int&gt;,
#   r_middle_frontal_gyrus &lt;int&gt;, l_inferior_frontal_gyrus &lt;int&gt;,
#   r_inferior_frontal_gyrus &lt;int&gt;, l_precentral_gyrus &lt;int&gt;,
#   r_precentral_gyrus &lt;int&gt;, l_middle_orbitofrontal_gyrus &lt;int&gt;,
#   r_middle_orbitofrontal_gyrus &lt;int&gt;, l_lateral_orbitofrontal_gyrus &lt;int&gt;,
#   r_lateral_orbitofrontal_gyrus &lt;int&gt;, l_gyrus_rectus &lt;int&gt;, …</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(utils<span class="sc">::</span><span class="fu">head</span>(asc_lc, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 66
   subject   age    dx   sex fs_iq     tbv    gmv    wmv    csf background
     &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;   &lt;int&gt;  &lt;int&gt;  &lt;int&gt;  &lt;int&gt;      &lt;int&gt;
 1     776     8     1     1   101 1502702 567365 776399 158938    8597094
 2     785     8     1     2    87 1319737 505742 622518 191477    8636077
 3     804    15     1     1    97 1688990 745760 727705 215525    8561299
 4     119    13     2     2    65 1066075 327078 613545 125453    8683378
 5     787     8     2     1    74 1476254 561629 744490 170135    8629059
 6     806     8     1     1    91 1292641 496689 627691 168261    8661637
 7     410    16     1     1   108 1474790 774131 520734 179924    8689876
 8     120    13     2     2    96 1297327 439613 711602 146112    8687155
 9     189    18     2     1    79 1177002 426883 583387 166732    8659292
10     775    14     2     1    85 1325525 633171 514362 177992    8625635
# ℹ 56 more variables: l_superior_frontal_gyrus &lt;int&gt;,
#   r_superior_frontal_gyrus &lt;int&gt;, l_middle_frontal_gyrus &lt;int&gt;,
#   r_middle_frontal_gyrus &lt;int&gt;, l_inferior_frontal_gyrus &lt;int&gt;,
#   r_inferior_frontal_gyrus &lt;int&gt;, l_precentral_gyrus &lt;int&gt;,
#   r_precentral_gyrus &lt;int&gt;, l_middle_orbitofrontal_gyrus &lt;int&gt;,
#   r_middle_orbitofrontal_gyrus &lt;int&gt;, l_lateral_orbitofrontal_gyrus &lt;int&gt;,
#   r_lateral_orbitofrontal_gyrus &lt;int&gt;, l_gyrus_rectus &lt;int&gt;, …</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Frequency &amp; probability tables for Age, FS_IQ, Sex</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>freq_age  <span class="ot">&lt;-</span> <span class="fu">table</span>(schizo<span class="sc">$</span>age,  <span class="at">useNA =</span> <span class="st">"ifany"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>freq_fsiq <span class="ot">&lt;-</span> <span class="fu">table</span>(schizo<span class="sc">$</span>fs_iq, <span class="at">useNA =</span> <span class="st">"ifany"</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>freq_sex  <span class="ot">&lt;-</span> <span class="fu">table</span>(schizo<span class="sc">$</span>sex,   <span class="at">useNA =</span> <span class="st">"ifany"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>prob_age  <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(freq_age)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>prob_fsiq <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(freq_fsiq)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>prob_sex  <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(freq_sex)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">list</span>(</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">freq_age  =</span> <span class="fu">as.data.frame</span>(freq_age),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">freq_fsiq =</span> <span class="fu">as.data.frame</span>(freq_fsiq),</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">freq_sex  =</span> <span class="fu">as.data.frame</span>(freq_sex),</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob_age  =</span> <span class="fu">as.data.frame</span>(prob_age),</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob_fsiq =</span> <span class="fu">as.data.frame</span>(prob_fsiq),</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob_sex  =</span> <span class="fu">as.data.frame</span>(prob_sex)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$freq_age
   Var1 Freq
1     7    1
2     8    6
3     9    3
4    10    4
5    11    2
6    12    2
7    13    3
8    14    5
9    15   14
10   16    9
11   17    5
12   18    8
13   19    1

$freq_fsiq
   Var1 Freq
1    55    1
2    59    1
3    60    1
4    64    1
5    65    1
6    68    1
7    74    1
8    78    1
9    79    2
10   81    2
11   84    1
12   85    1
13   86    3
14   87    2
15   90    1
16   91    2
17   93    2
18   94    1
19   95    2
20   96    2
21   97    1
22   99    2
23  100    1
24  101    1
25  102    1
26  104    1
27  107    5
28  108    1
29  109    2
30  110    1
31  112    2
32  114    2
33  115    2
34  116    2
35  117    1
36  118    1
37  121    1
38  122    1
39  125    2
40  127    2
41  130    1
42  133    1

$freq_sex
  Var1 Freq
1    1   35
2    2   28

$prob_age
   Var1       Freq
1     7 0.01587302
2     8 0.09523810
3     9 0.04761905
4    10 0.06349206
5    11 0.03174603
6    12 0.03174603
7    13 0.04761905
8    14 0.07936508
9    15 0.22222222
10   16 0.14285714
11   17 0.07936508
12   18 0.12698413
13   19 0.01587302

$prob_fsiq
   Var1       Freq
1    55 0.01587302
2    59 0.01587302
3    60 0.01587302
4    64 0.01587302
5    65 0.01587302
6    68 0.01587302
7    74 0.01587302
8    78 0.01587302
9    79 0.03174603
10   81 0.03174603
11   84 0.01587302
12   85 0.01587302
13   86 0.04761905
14   87 0.03174603
15   90 0.01587302
16   91 0.03174603
17   93 0.03174603
18   94 0.01587302
19   95 0.03174603
20   96 0.03174603
21   97 0.01587302
22   99 0.03174603
23  100 0.01587302
24  101 0.01587302
25  102 0.01587302
26  104 0.01587302
27  107 0.07936508
28  108 0.01587302
29  109 0.03174603
30  110 0.01587302
31  112 0.03174603
32  114 0.03174603
33  115 0.03174603
34  116 0.03174603
35  117 0.01587302
36  118 0.01587302
37  121 0.01587302
38  122 0.01587302
39  125 0.03174603
40  127 0.03174603
41  130 0.01587302
42  133 0.01587302

$prob_sex
  Var1      Freq
1    1 0.5555556
2    2 0.4444444</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Mean Age &amp; correlation(Age, FS_IQ)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>mean_age <span class="ot">&lt;-</span> <span class="fu">mean</span>(schizo<span class="sc">$</span>age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>corr_age_fsiq <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(stats<span class="sc">::</span><span class="fu">cor</span>(schizo<span class="sc">$</span>age, schizo<span class="sc">$</span>fs_iq, <span class="at">use =</span> <span class="st">"complete.obs"</span>))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tibble<span class="sc">::</span><span class="fu">tibble</span>(mean_age, corr_age_fsiq))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  mean_age corr_age_fsiq
     &lt;dbl&gt;         &lt;dbl&gt;
1     14.0         0.196</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Plots</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram + density of R_fusiform_gyrus (if available)</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"r_fusiform_gyrus"</span> <span class="sc">%in%</span> <span class="fu">names</span>(schizo)) {</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(schizo, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> r_fusiform_gyrus)) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"R_fusiform_gyrus: Histogram &amp; Density"</span>, <span class="at">x =</span> <span class="st">"R_fusiform_gyrus"</span>, <span class="at">y =</span> <span class="st">"Density"</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p1)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Column 'r_fusiform_gyrus' not found; skipping histogram+density plot."</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="HS605_problemset1_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter: L_fusiform_gyrus vs L_insular_cortex (if both available)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"l_fusiform_gyrus"</span>,<span class="st">"l_insular_cortex"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(schizo))) {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(schizo, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> l_fusiform_gyrus, <span class="at">y =</span> l_insular_cortex)) <span class="sc">+</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"L_fusiform_gyrus vs L_insular_cortex"</span>, <span class="at">x =</span> <span class="st">"L_fusiform_gyrus"</span>, <span class="at">y =</span> <span class="st">"L_insular_cortex"</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p2)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Columns 'l_fusiform_gyrus' and/or 'l_insular_cortex' not found; skipping scatter plot."</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="HS605_problemset1_files/figure-html/unnamed-chunk-2-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Problem 1.3: Simulation &amp; Q–Q (robust, base R) ----</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">506</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate samples</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>x_norm <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10000</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>y_t    <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rt</span>(<span class="dv">5000</span>, <span class="at">df =</span> <span class="dv">5</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Q–Q: empirical quantiles of N(0,1) vs t(5)</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(x_norm), <span class="fu">length</span>(y_t))</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>probs <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">ppoints</span>(n)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>qx <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">quantile</span>(x_norm, <span class="at">probs =</span> probs)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>qy <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">quantile</span>(y_t,    <span class="at">probs =</span> probs)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>graphics<span class="sc">::</span><span class="fu">plot</span>(qx, qy,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">xlab =</span> <span class="st">"Quantiles of N(0,1) sample"</span>,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">ylab =</span> <span class="st">"Quantiles of t(df=5) sample"</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>               <span class="at">main =</span> <span class="st">"Q–Q: Normal vs Student t (df = 5)"</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>graphics<span class="sc">::</span><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="HS605_problemset1_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare with qqnorm() for the t sample</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>stats<span class="sc">::</span><span class="fu">qqnorm</span>(y_t, <span class="at">main =</span> <span class="st">"qqnorm(): t(df=5) sample"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>stats<span class="sc">::</span><span class="fu">qqline</span>(y_t, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="HS605_problemset1_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># (Optional) Interactive qqnorm with plotly if available; otherwise silently skip</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"plotly"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  theo <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">qnorm</span>(stats<span class="sc">::</span><span class="fu">ppoints</span>(<span class="fu">length</span>(y_t)))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  emp  <span class="ot">&lt;-</span> <span class="fu">sort</span>(y_t)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  plt <span class="ot">&lt;-</span> plotly<span class="sc">::</span><span class="fu">plot_ly</span>(<span class="at">x =</span> theo, <span class="at">y =</span> emp, <span class="at">type =</span> <span class="st">"scatter"</span>, <span class="at">mode =</span> <span class="st">"markers"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  plt <span class="ot">&lt;-</span> plotly<span class="sc">::</span><span class="fu">layout</span>(plt,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">title =</span> <span class="st">"Interactive qqnorm: t(df=5)"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">xaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Theoretical Normal Quantiles"</span>),</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">yaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Sample Quantiles (t, df=5)"</span>))</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(<span class="fu">print</span>(plt))</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Interpretation:</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"- t(df=5) has heavier tails than N(0,1): points deviate from the 45° line in both tails.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"- qqnorm(y_t) likewise bows in the tails, showing excess kurtosis vs. normal.</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Interpretation:
- t(df=5) has heavier tails than N(0,1): points deviate from the 45° line in both tails.
- qqnorm(y_t) likewise bows in the tails, showing excess kurtosis vs. normal.</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Problem 1.4: Robust myMode() (pure base R) ----</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>myMode <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute mode for an atomic vector (numeric/character/logical)</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  .mode_atomic <span class="ot">&lt;-</span> <span class="cf">function</span>(v) {</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    v_no_na <span class="ot">&lt;-</span> v[<span class="sc">!</span><span class="fu">is.na</span>(v)]</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(v_no_na)) {</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">modes =</span> <span class="cn">NA</span>, <span class="at">count =</span> <span class="dv">0</span>L, <span class="at">ties =</span> <span class="cn">FALSE</span>, <span class="at">total_n =</span> <span class="fu">length</span>(v), <span class="at">unique_n =</span> <span class="dv">0</span>L))</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    tab <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">table</span>(v_no_na, <span class="at">useNA =</span> <span class="st">"no"</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    maxc <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">max</span>(tab)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    modes_chr <span class="ot">&lt;-</span> <span class="fu">names</span>(tab)[tab <span class="sc">==</span> maxc]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try casting modes back to numeric if the data are numeric-like</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    cast_back <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(modes_chr))</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.numeric</span>(v_no_na) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(cast_back))) {</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>      modes_val <span class="ot">&lt;-</span> cast_back</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>      modes_val <span class="ot">&lt;-</span> modes_chr</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">modes    =</span> modes_val,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">count    =</span> <span class="fu">as.integer</span>(maxc),</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">ties     =</span> <span class="fu">length</span>(modes_val) <span class="sc">&gt;</span> <span class="dv">1</span>,</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_n  =</span> <span class="fu">length</span>(v),</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">unique_n =</span> <span class="fu">length</span>(tab)</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data frame: column-wise</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.data.frame</span>(x)) <span class="fu">return</span>(<span class="fu">lapply</span>(x, myMode))</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># General list (non-atomic): element-wise</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.list</span>(x) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.atomic</span>(x)) <span class="fu">return</span>(<span class="fu">lapply</span>(x, myMode))</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Arrays / matrices: flatten then compute</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.array</span>(x) <span class="sc">||</span> <span class="fu">is.matrix</span>(x)) <span class="fu">return</span>(<span class="fu">.mode_atomic</span>(<span class="fu">as.vector</span>(x)))</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Factors -&gt; character; dates/times -&gt; numeric</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(x)) x <span class="ot">&lt;-</span> <span class="fu">as.character</span>(x)</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(x, <span class="st">"Date"</span>) <span class="sc">||</span> <span class="fu">inherits</span>(x, <span class="st">"POSIXct"</span>) <span class="sc">||</span> <span class="fu">inherits</span>(x, <span class="st">"POSIXt"</span>)) x <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(x)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Atomic vectors</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.atomic</span>(x)) <span class="fu">return</span>(<span class="fu">.mode_atomic</span>(x))</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fallback</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">modes =</span> <span class="cn">NA</span>, <span class="at">count =</span> <span class="cn">NA_integer_</span>, <span class="at">ties =</span> <span class="cn">NA</span>, <span class="at">total_n =</span> <span class="fu">length</span>(x), <span class="at">unique_n =</span> <span class="cn">NA_integer_</span>)</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Quick tests (self-contained) ----</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate samples</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">507</span>)</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>x_norm <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10000</span>)</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>y_t    <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rt</span>(<span class="dv">5000</span>, <span class="at">df =</span> <span class="dv">5</span>)</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>mode_norm <span class="ot">&lt;-</span> <span class="fu">myMode</span>(x_norm)  <span class="co"># for continuous data, ties likely (many singletons)</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>mode_t    <span class="ot">&lt;-</span> <span class="fu">myMode</span>(y_t)</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>char_vec  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"a"</span>,<span class="st">"b"</span>,<span class="st">"a"</span>,<span class="st">"c"</span>,<span class="st">"b"</span>,<span class="st">"a"</span>, <span class="cn">NA</span>, <span class="st">"c"</span>)</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>mode_char <span class="ot">&lt;-</span> <span class="fu">myMode</span>(char_vec)</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>arr <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="cn">NA</span>,<span class="dv">4</span>), <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>mode_arr <span class="ot">&lt;-</span> <span class="fu">myMode</span>(arr)</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>df_mixed <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="cn">NA</span>),</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"x"</span>,<span class="st">"z"</span>,<span class="st">"x"</span>,<span class="cn">NA</span>,<span class="st">"x"</span>),</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">c =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"lo"</span>,<span class="st">"lo"</span>,<span class="st">"hi"</span>,<span class="st">"lo"</span>,<span class="st">"hi"</span>,<span class="st">"hi"</span>,<span class="st">"hi"</span>)),</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>mode_df <span class="ot">&lt;-</span> <span class="fu">myMode</span>(df_mixed)</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"myMode(x_norm): count ="</span>, mode_norm<span class="sc">$</span>count, <span class="st">" ties ="</span>, mode_norm<span class="sc">$</span>ties, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>myMode(x_norm): count = 1  ties = TRUE </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"myMode(y_t):    count ="</span>, mode_t<span class="sc">$</span>count,    <span class="st">" ties ="</span>, mode_t<span class="sc">$</span>ties,    <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>myMode(y_t):    count = 1  ties = TRUE </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"myMode(char):   modes ="</span>, <span class="fu">paste</span>(mode_char<span class="sc">$</span>modes, <span class="at">collapse =</span> <span class="st">","</span>),</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">" count ="</span>, mode_char<span class="sc">$</span>count, <span class="st">" ties ="</span>, mode_char<span class="sc">$</span>ties, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>myMode(char):   modes = a  count = 3  ties = FALSE </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"myMode(array):  modes ="</span>, <span class="fu">paste</span>(mode_arr<span class="sc">$</span>modes, <span class="at">collapse =</span> <span class="st">","</span>),</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">" count ="</span>, mode_arr<span class="sc">$</span>count,  <span class="st">" ties ="</span>, mode_arr<span class="sc">$</span>ties,  <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>myMode(array):  modes = 3  count = 3  ties = FALSE </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"myMode(df):     per-column results below.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>myMode(df):     per-column results below.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mode_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$a
$a$modes
[1] 3

$a$count
[1] 3

$a$ties
[1] FALSE

$a$total_n
[1] 7

$a$unique_n
[1] 3


$b
$b$modes
[1] "x"

$b$count
[1] 4

$b$ties
[1] FALSE

$b$total_n
[1] 7

$b$unique_n
[1] 3


$c
$c$modes
[1] "hi"

$c$count
[1] 4

$c$ties
[1] FALSE

$c$total_n
[1] 7

$c$unique_n
[1] 2</code></pre>
</div>
</div>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb35" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="fu">## ;</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="fu"># HW Problem Set 1</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="fu"># Fall 2025, DSPA (HS650)</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="fu"># Name: Charlie Jordan</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="fu"># SID: 0434</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="fu"># UMich E-mail: cejordan@umich.edu</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="fu"># I certify that the following paper represents my own independent work and conforms with the guidelines of academic honesty described in the UMich student handbook.</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="fu"># Remember you are allowed and encouraged to discuss, on a conceptual level, the problems with your class mates, however, this can not involve the exchange of actual code, printouts, solutions, e-mails or other explicit electronic or paper handouts.</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="fu"># Homeworks and Projects</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Problem 1.1: ultra-robust SOCR HPI loader (fixed pipes) ---</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>need <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"rvest"</span>,<span class="st">"xml2"</span>,<span class="st">"stringr"</span>,<span class="st">"readr"</span>,<span class="st">"dplyr"</span>,<span class="st">"tidyr"</span>,<span class="st">"janitor"</span>,<span class="st">"purrr"</span>)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>inst <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(need, <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()))</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(inst)) <span class="fu">install.packages</span>(inst, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(rvest); <span class="fu">library</span>(xml2); <span class="fu">library</span>(stringr); <span class="fu">library</span>(readr)</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr); <span class="fu">library</span>(tidyr); <span class="fu">library</span>(janitor); <span class="fu">library</span>(purrr)</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>url_base <span class="ot">&lt;-</span> <span class="st">"https://wiki.socr.umich.edu/index.php/SOCR_Data_Dinov_010309_HousingPriceIndex"</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- helpers ----------</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>parse_rows <span class="ot">&lt;-</span> <span class="cf">function</span>(lines) {</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>  pat <span class="ot">&lt;-</span> <span class="st">"^[A-Za-z][A-Za-z_ ]*</span><span class="sc">\\</span><span class="st">s+(19|20)</span><span class="sc">\\</span><span class="st">d{2}</span><span class="sc">\\</span><span class="st">s+[-+]?</span><span class="sc">\\</span><span class="st">d*</span><span class="sc">\\</span><span class="st">.?</span><span class="sc">\\</span><span class="st">d+</span><span class="sc">\\</span><span class="st">s+[-+]?</span><span class="sc">\\</span><span class="st">d*</span><span class="sc">\\</span><span class="st">.?</span><span class="sc">\\</span><span class="st">d+</span><span class="sc">\\</span><span class="st">s+[A-Za-z_]+</span><span class="sc">\\</span><span class="st">s+[-+]?</span><span class="sc">\\</span><span class="st">d*</span><span class="sc">\\</span><span class="st">.?</span><span class="sc">\\</span><span class="st">d+%?</span><span class="sc">\\</span><span class="st">s+[-+]?</span><span class="sc">\\</span><span class="st">d*</span><span class="sc">\\</span><span class="st">.?</span><span class="sc">\\</span><span class="st">d+%?$"</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>  dl <span class="ot">&lt;-</span> lines[<span class="fu">str_detect</span>(lines, pat)]</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(dl)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>  dl <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(dl, <span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span>, <span class="st">" "</span>)</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>  txt <span class="ot">&lt;-</span> <span class="fu">paste</span>(dl, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_table2</span>(</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    txt,</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">"state"</span>,<span class="st">"year"</span>,<span class="st">"hpi"</span>,<span class="st">"ur"</span>,<span class="st">"region"</span>,<span class="st">"pop"</span>,<span class="st">"percent"</span>),</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_types =</span> <span class="fu">cols</span>(</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">state  =</span> <span class="fu">col_character</span>(),</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">year   =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">hpi    =</span> <span class="fu">col_double</span>(),</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">ur     =</span> <span class="fu">col_double</span>(),</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">region =</span> <span class="fu">col_character</span>(),</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop     =</span> <span class="fu">col_character</span>(),</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">percent =</span> <span class="fu">col_character</span>()</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop     =</span> <span class="fu">as.numeric</span>(<span class="fu">str_replace</span>(pop, <span class="st">"%"</span>,<span class="st">""</span>)),</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">percent =</span> <span class="fu">as.numeric</span>(<span class="fu">str_replace</span>(percent, <span class="st">"%"</span>,<span class="st">""</span>))</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_names</span>()</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>pick_best_table <span class="ot">&lt;-</span> <span class="cf">function</span>(tabs) {</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tabs)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>  tabs <span class="ot">&lt;-</span> <span class="fu">compact</span>(<span class="fu">lapply</span>(tabs, janitor<span class="sc">::</span>clean_names))</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tabs)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>    nm <span class="ot">&lt;-</span> <span class="fu">names</span>(df)</span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1000</span> <span class="sc">*</span> <span class="fu">sum</span>(<span class="fu">c</span>(<span class="st">"state"</span>,<span class="st">"year"</span>,<span class="st">"hpi"</span>) <span class="sc">%in%</span> nm) <span class="sc">+</span> <span class="fu">nrow</span>(df)</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>  tabs[[ <span class="fu">which.max</span>(<span class="fu">vapply</span>(tabs, score, <span class="fu">numeric</span>(<span class="dv">1</span>))) ]]</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a><span class="co"># A) direct HTML tables</span></span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>try_tables <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> <span class="fu">read_html</span>(url)</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>  tables <span class="ot">&lt;-</span> <span class="fu">html_table</span>(pg, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>  best <span class="ot">&lt;-</span> <span class="fu">pick_best_table</span>(tables)</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(best)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>  nm <span class="ot">&lt;-</span> <span class="fu">names</span>(best)</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>  ren <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state"</span>   <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^state$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year"</span>    <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^year$"</span>,  nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hpi"</span>     <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^hpi"</span>,    nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ur"</span>      <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^ur$|unemployment"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">"region"</span>  <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^region$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pop"</span>     <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^pop"</span>,     nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">"percent"</span> <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^percent$|^perc"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>  ren <span class="ot">&lt;-</span> ren[<span class="sc">!</span><span class="fu">is.na</span>(ren)]</span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">unname</span>(ren), <span class="fu">names</span>(best)); keep <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(idx)</span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(best)[idx[keep]] <span class="ot">&lt;-</span> <span class="fu">names</span>(ren)[keep]</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"state"</span>,<span class="st">"year"</span>,<span class="st">"hpi"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(best))) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>  best <span class="sc">%&gt;%</span></span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>      <span class="at">year    =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.integer</span>(year)),</span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>      <span class="at">hpi     =</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(hpi)),</span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>      <span class="at">ur      =</span> <span class="cf">if</span> (<span class="st">"ur"</span> <span class="sc">%in%</span> <span class="fu">names</span>(.)) <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(ur)) <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop     =</span> <span class="cf">if</span> (<span class="st">"pop"</span> <span class="sc">%in%</span> <span class="fu">names</span>(.)) <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(<span class="fu">str_replace</span>(pop, <span class="st">"%"</span>,<span class="st">""</span>))) <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">percent =</span> <span class="cf">if</span> (<span class="st">"percent"</span> <span class="sc">%in%</span> <span class="fu">names</span>(.)) <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(<span class="fu">str_replace</span>(percent, <span class="st">"%"</span>,<span class="st">""</span>))) <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">region  =</span> <span class="cf">if</span> (<span class="st">"region"</span> <span class="sc">%in%</span> <span class="fu">names</span>(.)) <span class="fu">as.character</span>(region) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">any_of</span>(<span class="fu">c</span>(<span class="st">"state"</span>,<span class="st">"year"</span>,<span class="st">"hpi"</span>,<span class="st">"ur"</span>,<span class="st">"region"</span>,<span class="st">"pop"</span>,<span class="st">"percent"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(state, year)</span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a><span class="co"># B) pre/code blocks</span></span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>try_pre_blocks <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> <span class="fu">read_html</span>(url)</span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a>  blocks <span class="ot">&lt;-</span> <span class="fu">html_elements</span>(pg, <span class="st">"pre, code, .mw-highlight, .mw-code"</span>)</span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(blocks)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a>  text_all <span class="ot">&lt;-</span> <span class="fu">html_text2</span>(blocks)</span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a>  text_join <span class="ot">&lt;-</span> <span class="fu">paste</span>(text_all, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">str_split</span>(text_join, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[[<span class="dv">1</span>]]</span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines)</span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_rows</span>(lines)</span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a><span class="co"># C) raw edit view</span></span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a>try_edit_raw <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="fu">paste0</span>(url, <span class="st">"?action=edit"</span>))</span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a>  tx <span class="ot">&lt;-</span> <span class="fu">html_elements</span>(pg, <span class="st">"textarea#wpTextbox1"</span>)</span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tx)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a>  raw <span class="ot">&lt;-</span> <span class="fu">html_text2</span>(tx[[<span class="dv">1</span>]])</span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">str_split</span>(raw, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[[<span class="dv">1</span>]]</span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines)</span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_rows</span>(lines)</span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a><span class="co"># D) printable view</span></span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a>try_printable <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="fu">paste0</span>(url, <span class="st">"?printable=yes"</span>))</span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">html_element</span>(pg, <span class="st">"#mw-content-text"</span>)</span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(el)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a>  txt <span class="ot">&lt;-</span> <span class="fu">html_text2</span>(el)</span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">str_split</span>(txt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[[<span class="dv">1</span>]]</span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines)</span>
<span id="cb35-146"><a href="#cb35-146" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb35-147"><a href="#cb35-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_rows</span>(lines)</span>
<span id="cb35-148"><a href="#cb35-148" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-149"><a href="#cb35-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-150"><a href="#cb35-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Run strategies in order</span></span>
<span id="cb35-151"><a href="#cb35-151" aria-hidden="true" tabindex="-1"></a>hpi <span class="ot">&lt;-</span> <span class="fu">try_tables</span>(url_base)</span>
<span id="cb35-152"><a href="#cb35-152" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(hpi)) hpi <span class="ot">&lt;-</span> <span class="fu">try_pre_blocks</span>(url_base)</span>
<span id="cb35-153"><a href="#cb35-153" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(hpi)) hpi <span class="ot">&lt;-</span> <span class="fu">try_edit_raw</span>(url_base)</span>
<span id="cb35-154"><a href="#cb35-154" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(hpi)) hpi <span class="ot">&lt;-</span> <span class="fu">try_printable</span>(url_base)</span>
<span id="cb35-155"><a href="#cb35-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-156"><a href="#cb35-156" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(hpi) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(hpi) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(hpi)) {</span>
<span id="cb35-157"><a href="#cb35-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Could not locate the data on the page. If campus proxy rewrites pages, copy the data block into a text file and read with readr::read_table2()."</span>)</span>
<span id="cb35-158"><a href="#cb35-158" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-159"><a href="#cb35-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-160"><a href="#cb35-160" aria-hidden="true" tabindex="-1"></a><span class="co"># --------- Long -&gt; Wide ---------</span></span>
<span id="cb35-161"><a href="#cb35-161" aria-hidden="true" tabindex="-1"></a>wide_hpi <span class="ot">&lt;-</span> hpi <span class="sc">%&gt;%</span></span>
<span id="cb35-162"><a href="#cb35-162" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb35-163"><a href="#cb35-163" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols     =</span> state,</span>
<span id="cb35-164"><a href="#cb35-164" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from  =</span> year,</span>
<span id="cb35-165"><a href="#cb35-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(hpi), <span class="fu">c</span>(<span class="st">"state"</span>,<span class="st">"year"</span>))),</span>
<span id="cb35-166"><a href="#cb35-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_glue  =</span> <span class="st">"{.value}{year}"</span></span>
<span id="cb35-167"><a href="#cb35-167" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-168"><a href="#cb35-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-169"><a href="#cb35-169" aria-hidden="true" tabindex="-1"></a><span class="co"># --------- Wide -&gt; Long ---------</span></span>
<span id="cb35-170"><a href="#cb35-170" aria-hidden="true" tabindex="-1"></a>long_back <span class="ot">&lt;-</span> wide_hpi <span class="sc">%&gt;%</span></span>
<span id="cb35-171"><a href="#cb35-171" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb35-172"><a href="#cb35-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span>state,</span>
<span id="cb35-173"><a href="#cb35-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>,<span class="st">"year"</span>),</span>
<span id="cb35-174"><a href="#cb35-174" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"^(.*?)(</span><span class="sc">\\</span><span class="st">d{4})$"</span>,</span>
<span id="cb35-175"><a href="#cb35-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_drop_na =</span> <span class="cn">TRUE</span></span>
<span id="cb35-176"><a href="#cb35-176" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb35-177"><a href="#cb35-177" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.integer</span>(year)) <span class="sc">%&gt;%</span></span>
<span id="cb35-178"><a href="#cb35-178" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(state, year)</span>
<span id="cb35-179"><a href="#cb35-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-180"><a href="#cb35-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Checks &amp; peeks</span></span>
<span id="cb35-181"><a href="#cb35-181" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(long_back<span class="sc">$</span>state) <span class="sc">==</span> dplyr<span class="sc">::</span><span class="fu">n_distinct</span>(hpi<span class="sc">$</span>state))</span>
<span id="cb35-182"><a href="#cb35-182" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(hpi, <span class="dv">12</span>)); <span class="fu">print</span>(<span class="fu">head</span>(wide_hpi, <span class="dv">3</span>)); <span class="fu">print</span>(<span class="fu">head</span>(long_back, <span class="dv">12</span>))</span>
<span id="cb35-183"><a href="#cb35-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-184"><a href="#cb35-184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-185"><a href="#cb35-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-188"><a href="#cb35-188" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-189"><a href="#cb35-189" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Problem 1.2 (Ultra-robust loader + analysis) ---</span></span>
<span id="cb35-190"><a href="#cb35-190" aria-hidden="true" tabindex="-1"></a>need <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"rvest"</span>,<span class="st">"xml2"</span>,<span class="st">"stringr"</span>,<span class="st">"readr"</span>,<span class="st">"dplyr"</span>,<span class="st">"tidyr"</span>,<span class="st">"janitor"</span>,<span class="st">"purrr"</span>,<span class="st">"ggplot2"</span>)</span>
<span id="cb35-191"><a href="#cb35-191" aria-hidden="true" tabindex="-1"></a>inst <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(need, <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()))</span>
<span id="cb35-192"><a href="#cb35-192" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(inst)) <span class="fu">install.packages</span>(inst, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-193"><a href="#cb35-193" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb35-194"><a href="#cb35-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(rvest); <span class="fu">library</span>(xml2); <span class="fu">library</span>(stringr); <span class="fu">library</span>(readr)</span>
<span id="cb35-195"><a href="#cb35-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr); <span class="fu">library</span>(tidyr); <span class="fu">library</span>(janitor); <span class="fu">library</span>(purrr); <span class="fu">library</span>(ggplot2)</span>
<span id="cb35-196"><a href="#cb35-196" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb35-197"><a href="#cb35-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-198"><a href="#cb35-198" aria-hidden="true" tabindex="-1"></a>url_base <span class="ot">&lt;-</span> <span class="st">"https://wiki.socr.umich.edu/index.php/SOCR_Data_Oct2009_ID_NI"</span></span>
<span id="cb35-199"><a href="#cb35-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-200"><a href="#cb35-200" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- helpers ----------</span></span>
<span id="cb35-201"><a href="#cb35-201" aria-hidden="true" tabindex="-1"></a>pick_best_table <span class="ot">&lt;-</span> <span class="cf">function</span>(tabs) {</span>
<span id="cb35-202"><a href="#cb35-202" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tabs)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-203"><a href="#cb35-203" aria-hidden="true" tabindex="-1"></a>  tabs <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">compact</span>(<span class="fu">lapply</span>(tabs, janitor<span class="sc">::</span>clean_names))</span>
<span id="cb35-204"><a href="#cb35-204" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tabs)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-205"><a href="#cb35-205" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb35-206"><a href="#cb35-206" aria-hidden="true" tabindex="-1"></a>    nm <span class="ot">&lt;-</span> <span class="fu">names</span>(df)</span>
<span id="cb35-207"><a href="#cb35-207" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reward presence of expected cols, then rowcount</span></span>
<span id="cb35-208"><a href="#cb35-208" aria-hidden="true" tabindex="-1"></a>    want <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"subject"</span>,<span class="st">"age"</span>,<span class="st">"fs_iq"</span>,<span class="st">"sex"</span>,<span class="st">"l_caudate"</span>)</span>
<span id="cb35-209"><a href="#cb35-209" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1000</span> <span class="sc">*</span> <span class="fu">sum</span>(want <span class="sc">%in%</span> nm) <span class="sc">+</span> <span class="fu">nrow</span>(df)</span>
<span id="cb35-210"><a href="#cb35-210" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-211"><a href="#cb35-211" aria-hidden="true" tabindex="-1"></a>  tabs[[ <span class="fu">which.max</span>(<span class="fu">vapply</span>(tabs, score, <span class="fu">numeric</span>(<span class="dv">1</span>))) ]]</span>
<span id="cb35-212"><a href="#cb35-212" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-213"><a href="#cb35-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-214"><a href="#cb35-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Try to parse a whitespace table from lines when no HTML table exists</span></span>
<span id="cb35-215"><a href="#cb35-215" aria-hidden="true" tabindex="-1"></a>parse_from_lines <span class="ot">&lt;-</span> <span class="cf">function</span>(lines) {</span>
<span id="cb35-216"><a href="#cb35-216" aria-hidden="true" tabindex="-1"></a>  <span class="co"># find a header line that has Subject + Age (and optionally FS_IQ etc.)</span></span>
<span id="cb35-217"><a href="#cb35-217" aria-hidden="true" tabindex="-1"></a>  hdr_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"Subject"</span>, lines, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;</span></span>
<span id="cb35-218"><a href="#cb35-218" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">grepl</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">bAge</span><span class="sc">\\</span><span class="st">b"</span>, lines, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb35-219"><a href="#cb35-219" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(hdr_idx)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-220"><a href="#cb35-220" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Take the first header occurrence and consume subsequent non-empty lines</span></span>
<span id="cb35-221"><a href="#cb35-221" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> hdr_idx[<span class="dv">1</span>]</span>
<span id="cb35-222"><a href="#cb35-222" aria-hidden="true" tabindex="-1"></a>  tail_lines <span class="ot">&lt;-</span> lines[(start<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(lines)]</span>
<span id="cb35-223"><a href="#cb35-223" aria-hidden="true" tabindex="-1"></a>  tail_lines <span class="ot">&lt;-</span> tail_lines[ <span class="fu">nzchar</span>(<span class="fu">trimws</span>(tail_lines)) ]</span>
<span id="cb35-224"><a href="#cb35-224" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tail_lines)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-225"><a href="#cb35-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-226"><a href="#cb35-226" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build colnames by splitting header on whitespace</span></span>
<span id="cb35-227"><a href="#cb35-227" aria-hidden="true" tabindex="-1"></a>  header_line <span class="ot">&lt;-</span> lines[start]</span>
<span id="cb35-228"><a href="#cb35-228" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">str_split</span>(header_line, <span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>); col_names <span class="ot">&lt;-</span> col_names[col_names <span class="sc">!=</span> <span class="st">""</span>]</span>
<span id="cb35-229"><a href="#cb35-229" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">tolower</span>(col_names)</span>
<span id="cb35-230"><a href="#cb35-230" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean typical header variants</span></span>
<span id="cb35-231"><a href="#cb35-231" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^a-z0-9_]+"</span>, <span class="st">"_"</span>, col_names)</span>
<span id="cb35-232"><a href="#cb35-232" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Common canonical names map (be generous)</span></span>
<span id="cb35-233"><a href="#cb35-233" aria-hidden="true" tabindex="-1"></a>  fixmap <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb35-234"><a href="#cb35-234" aria-hidden="true" tabindex="-1"></a>    <span class="st">"subject"</span><span class="ot">=</span><span class="st">"subject"</span>, <span class="st">"subj"</span><span class="ot">=</span><span class="st">"subject"</span>, <span class="st">"id"</span><span class="ot">=</span><span class="st">"subject"</span>,</span>
<span id="cb35-235"><a href="#cb35-235" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span><span class="ot">=</span><span class="st">"age"</span>,</span>
<span id="cb35-236"><a href="#cb35-236" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fs_iq"</span><span class="ot">=</span><span class="st">"fs_iq"</span>, <span class="st">"fsiq"</span><span class="ot">=</span><span class="st">"fs_iq"</span>, <span class="st">"fs-iq"</span><span class="ot">=</span><span class="st">"fs_iq"</span>,</span>
<span id="cb35-237"><a href="#cb35-237" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sex"</span><span class="ot">=</span><span class="st">"sex"</span>, <span class="st">"gender"</span><span class="ot">=</span><span class="st">"sex"</span>,</span>
<span id="cb35-238"><a href="#cb35-238" aria-hidden="true" tabindex="-1"></a>    <span class="st">"l_caudate"</span><span class="ot">=</span><span class="st">"l_caudate"</span>, <span class="st">"left_caudate"</span><span class="ot">=</span><span class="st">"l_caudate"</span>,</span>
<span id="cb35-239"><a href="#cb35-239" aria-hidden="true" tabindex="-1"></a>    <span class="st">"r_fusiform_gyrus"</span><span class="ot">=</span><span class="st">"r_fusiform_gyrus"</span>, <span class="st">"right_fusiform_gyrus"</span><span class="ot">=</span><span class="st">"r_fusiform_gyrus"</span>,</span>
<span id="cb35-240"><a href="#cb35-240" aria-hidden="true" tabindex="-1"></a>    <span class="st">"l_fusiform_gyrus"</span><span class="ot">=</span><span class="st">"l_fusiform_gyrus"</span>, <span class="st">"left_fusiform_gyrus"</span><span class="ot">=</span><span class="st">"l_fusiform_gyrus"</span>,</span>
<span id="cb35-241"><a href="#cb35-241" aria-hidden="true" tabindex="-1"></a>    <span class="st">"l_insular_cortex"</span><span class="ot">=</span><span class="st">"l_insular_cortex"</span>, <span class="st">"left_insular_cortex"</span><span class="ot">=</span><span class="st">"l_insular_cortex"</span></span>
<span id="cb35-242"><a href="#cb35-242" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-243"><a href="#cb35-243" aria-hidden="true" tabindex="-1"></a>  cn <span class="ot">&lt;-</span> fixmap[col_names]; cn[<span class="fu">is.na</span>(cn)] <span class="ot">&lt;-</span> col_names</span>
<span id="cb35-244"><a href="#cb35-244" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">make.names</span>(cn, <span class="at">unique =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-245"><a href="#cb35-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-246"><a href="#cb35-246" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only lines that look like data rows (start with an ID/Subject and contain numbers)</span></span>
<span id="cb35-247"><a href="#cb35-247" aria-hidden="true" tabindex="-1"></a>  data_cand <span class="ot">&lt;-</span> tail_lines[ <span class="fu">grepl</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">d"</span>, tail_lines) ]</span>
<span id="cb35-248"><a href="#cb35-248" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(data_cand)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-249"><a href="#cb35-249" aria-hidden="true" tabindex="-1"></a>  data_text <span class="ot">&lt;-</span> <span class="fu">paste</span>(data_cand, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-250"><a href="#cb35-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-251"><a href="#cb35-251" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try reading with read_table2 using discovered headers</span></span>
<span id="cb35-252"><a href="#cb35-252" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb35-253"><a href="#cb35-253" aria-hidden="true" tabindex="-1"></a>    readr<span class="sc">::</span><span class="fu">read_table2</span>(data_text, <span class="at">col_names =</span> col_names, <span class="at">guess_max =</span> <span class="dv">10000</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>),</span>
<span id="cb35-254"><a href="#cb35-254" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb35-255"><a href="#cb35-255" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-256"><a href="#cb35-256" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(df) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(df) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(df)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-257"><a href="#cb35-257" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>(df)</span>
<span id="cb35-258"><a href="#cb35-258" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-259"><a href="#cb35-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-260"><a href="#cb35-260" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy A: direct HTML tables</span></span>
<span id="cb35-261"><a href="#cb35-261" aria-hidden="true" tabindex="-1"></a>try_tables <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb35-262"><a href="#cb35-262" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">read_html</span>(url)</span>
<span id="cb35-263"><a href="#cb35-263" aria-hidden="true" tabindex="-1"></a>  tables <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_table</span>(pg, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-264"><a href="#cb35-264" aria-hidden="true" tabindex="-1"></a>  best <span class="ot">&lt;-</span> <span class="fu">pick_best_table</span>(tables)</span>
<span id="cb35-265"><a href="#cb35-265" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(best)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-266"><a href="#cb35-266" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>(best)</span>
<span id="cb35-267"><a href="#cb35-267" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-268"><a href="#cb35-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-269"><a href="#cb35-269" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy B: pre/code blocks</span></span>
<span id="cb35-270"><a href="#cb35-270" aria-hidden="true" tabindex="-1"></a>try_pre_blocks <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb35-271"><a href="#cb35-271" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">read_html</span>(url)</span>
<span id="cb35-272"><a href="#cb35-272" aria-hidden="true" tabindex="-1"></a>  blocks <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_elements</span>(pg, <span class="st">"pre, code, .mw-highlight, .mw-code"</span>)</span>
<span id="cb35-273"><a href="#cb35-273" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(blocks)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-274"><a href="#cb35-274" aria-hidden="true" tabindex="-1"></a>  text_all <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_text2</span>(blocks)</span>
<span id="cb35-275"><a href="#cb35-275" aria-hidden="true" tabindex="-1"></a>  text_join <span class="ot">&lt;-</span> <span class="fu">paste</span>(text_all, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-276"><a href="#cb35-276" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_split</span>(text_join, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)[[<span class="dv">1</span>]]</span>
<span id="cb35-277"><a href="#cb35-277" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines); lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb35-278"><a href="#cb35-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_from_lines</span>(lines)</span>
<span id="cb35-279"><a href="#cb35-279" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-280"><a href="#cb35-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-281"><a href="#cb35-281" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy C: raw edit view</span></span>
<span id="cb35-282"><a href="#cb35-282" aria-hidden="true" tabindex="-1"></a>try_edit_raw <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb35-283"><a href="#cb35-283" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">read_html</span>(<span class="fu">paste0</span>(url, <span class="st">"?action=edit"</span>))</span>
<span id="cb35-284"><a href="#cb35-284" aria-hidden="true" tabindex="-1"></a>  tx <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_elements</span>(pg, <span class="st">"textarea#wpTextbox1"</span>)</span>
<span id="cb35-285"><a href="#cb35-285" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(tx)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-286"><a href="#cb35-286" aria-hidden="true" tabindex="-1"></a>  raw <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_text2</span>(tx[[<span class="dv">1</span>]])</span>
<span id="cb35-287"><a href="#cb35-287" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_split</span>(raw, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)[[<span class="dv">1</span>]]</span>
<span id="cb35-288"><a href="#cb35-288" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines); lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb35-289"><a href="#cb35-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_from_lines</span>(lines)</span>
<span id="cb35-290"><a href="#cb35-290" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-291"><a href="#cb35-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-292"><a href="#cb35-292" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy D: printable view</span></span>
<span id="cb35-293"><a href="#cb35-293" aria-hidden="true" tabindex="-1"></a>try_printable <span class="ot">&lt;-</span> <span class="cf">function</span>(url) {</span>
<span id="cb35-294"><a href="#cb35-294" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">read_html</span>(<span class="fu">paste0</span>(url, <span class="st">"?printable=yes"</span>))</span>
<span id="cb35-295"><a href="#cb35-295" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_element</span>(pg, <span class="st">"#mw-content-text"</span>)</span>
<span id="cb35-296"><a href="#cb35-296" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(el)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb35-297"><a href="#cb35-297" aria-hidden="true" tabindex="-1"></a>  txt <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">html_text2</span>(el)</span>
<span id="cb35-298"><a href="#cb35-298" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_split</span>(txt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)[[<span class="dv">1</span>]]</span>
<span id="cb35-299"><a href="#cb35-299" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">trimws</span>(lines); lines <span class="ot">&lt;-</span> lines[<span class="fu">nzchar</span>(lines)]</span>
<span id="cb35-300"><a href="#cb35-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_from_lines</span>(lines)</span>
<span id="cb35-301"><a href="#cb35-301" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-302"><a href="#cb35-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-303"><a href="#cb35-303" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- load data with fallbacks ----------</span></span>
<span id="cb35-304"><a href="#cb35-304" aria-hidden="true" tabindex="-1"></a>schizo <span class="ot">&lt;-</span> <span class="fu">try_tables</span>(url_base)</span>
<span id="cb35-305"><a href="#cb35-305" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(schizo)) schizo <span class="ot">&lt;-</span> <span class="fu">try_pre_blocks</span>(url_base)</span>
<span id="cb35-306"><a href="#cb35-306" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(schizo)) schizo <span class="ot">&lt;-</span> <span class="fu">try_edit_raw</span>(url_base)</span>
<span id="cb35-307"><a href="#cb35-307" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(schizo)) schizo <span class="ot">&lt;-</span> <span class="fu">try_printable</span>(url_base)</span>
<span id="cb35-308"><a href="#cb35-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-309"><a href="#cb35-309" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(schizo) <span class="sc">||</span> <span class="sc">!</span><span class="fu">nrow</span>(schizo)) {</span>
<span id="cb35-310"><a href="#cb35-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Could not parse the Schizophrenia Neuroimaging dataset from the page."</span>)</span>
<span id="cb35-311"><a href="#cb35-311" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-312"><a href="#cb35-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-313"><a href="#cb35-313" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- normalize expected columns and types ----------</span></span>
<span id="cb35-314"><a href="#cb35-314" aria-hidden="true" tabindex="-1"></a>nm <span class="ot">&lt;-</span> <span class="fu">names</span>(schizo)</span>
<span id="cb35-315"><a href="#cb35-315" aria-hidden="true" tabindex="-1"></a><span class="co"># Build flexible mapping (only for columns that exist)</span></span>
<span id="cb35-316"><a href="#cb35-316" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb35-317"><a href="#cb35-317" aria-hidden="true" tabindex="-1"></a>  <span class="st">"subject"</span>           <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^subject$|^id$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-318"><a href="#cb35-318" aria-hidden="true" tabindex="-1"></a>  <span class="st">"age"</span>               <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^age$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-319"><a href="#cb35-319" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fs_iq"</span>             <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^fs[_]?iq$|^fsiq$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-320"><a href="#cb35-320" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sex"</span>               <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^sex$|^gender$"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-321"><a href="#cb35-321" aria-hidden="true" tabindex="-1"></a>  <span class="st">"l_caudate"</span>         <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^l[_]?caudate$|left[_ ]?caudate"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-322"><a href="#cb35-322" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_fusiform_gyrus"</span>  <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^r[_]?fusiform[_]?gyrus$|right[_ ]?fusiform"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-323"><a href="#cb35-323" aria-hidden="true" tabindex="-1"></a>  <span class="st">"l_fusiform_gyrus"</span>  <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^l[_]?fusiform[_]?gyrus$|left[_ ]?fusiform"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>],</span>
<span id="cb35-324"><a href="#cb35-324" aria-hidden="true" tabindex="-1"></a>  <span class="st">"l_insular_cortex"</span>  <span class="ot">=</span> <span class="fu">grep</span>(<span class="st">"^l[_]?insular[_]?cortex$|left[_ ]?insular"</span>, nm, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>, <span class="at">value =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]</span>
<span id="cb35-325"><a href="#cb35-325" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-326"><a href="#cb35-326" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> map[<span class="sc">!</span><span class="fu">is.na</span>(map)]</span>
<span id="cb35-327"><a href="#cb35-327" aria-hidden="true" tabindex="-1"></a><span class="co"># Base-R rename to avoid tidy-eval traps</span></span>
<span id="cb35-328"><a href="#cb35-328" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">unname</span>(map), <span class="fu">names</span>(schizo))</span>
<span id="cb35-329"><a href="#cb35-329" aria-hidden="true" tabindex="-1"></a>keep <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(idx)</span>
<span id="cb35-330"><a href="#cb35-330" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(schizo)[idx[keep]] <span class="ot">&lt;-</span> <span class="fu">names</span>(map)[keep]</span>
<span id="cb35-331"><a href="#cb35-331" aria-hidden="true" tabindex="-1"></a>schizo <span class="ot">&lt;-</span> janitor<span class="sc">::</span><span class="fu">clean_names</span>(schizo)</span>
<span id="cb35-332"><a href="#cb35-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-333"><a href="#cb35-333" aria-hidden="true" tabindex="-1"></a><span class="co"># Coerce numeric where appropriate (silently)</span></span>
<span id="cb35-334"><a href="#cb35-334" aria-hidden="true" tabindex="-1"></a>num_cols <span class="ot">&lt;-</span> <span class="fu">intersect</span>(</span>
<span id="cb35-335"><a href="#cb35-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"fs_iq"</span>,<span class="st">"l_caudate"</span>,<span class="st">"r_fusiform_gyrus"</span>,<span class="st">"l_fusiform_gyrus"</span>,<span class="st">"l_insular_cortex"</span>),</span>
<span id="cb35-336"><a href="#cb35-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(schizo)</span>
<span id="cb35-337"><a href="#cb35-337" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-338"><a href="#cb35-338" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(num_cols)) {</span>
<span id="cb35-339"><a href="#cb35-339" aria-hidden="true" tabindex="-1"></a>  schizo[num_cols] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(schizo[num_cols], <span class="cf">function</span>(x) <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(x)))</span>
<span id="cb35-340"><a href="#cb35-340" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-341"><a href="#cb35-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-342"><a href="#cb35-342" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- Problem 1.2 tasks ----------</span></span>
<span id="cb35-343"><a href="#cb35-343" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) First 10 subjects</span></span>
<span id="cb35-344"><a href="#cb35-344" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(utils<span class="sc">::</span><span class="fu">head</span>(schizo, <span class="dv">10</span>))</span>
<span id="cb35-345"><a href="#cb35-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-346"><a href="#cb35-346" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Cases with L_caudate &lt; 160</span></span>
<span id="cb35-347"><a href="#cb35-347" aria-hidden="true" tabindex="-1"></a>subset_lc_lt_160 <span class="ot">&lt;-</span> schizo <span class="sc">%&gt;%</span></span>
<span id="cb35-348"><a href="#cb35-348" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(l_caudate), l_caudate <span class="sc">&lt;</span> <span class="dv">160</span>)</span>
<span id="cb35-349"><a href="#cb35-349" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(subset_lc_lt_160)</span>
<span id="cb35-350"><a href="#cb35-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-351"><a href="#cb35-351" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Sort by L_caudate (descending &amp; ascending)</span></span>
<span id="cb35-352"><a href="#cb35-352" aria-hidden="true" tabindex="-1"></a>desc_lc <span class="ot">&lt;-</span> schizo <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(l_caudate))</span>
<span id="cb35-353"><a href="#cb35-353" aria-hidden="true" tabindex="-1"></a>asc_lc  <span class="ot">&lt;-</span> schizo <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">arrange</span>(l_caudate)</span>
<span id="cb35-354"><a href="#cb35-354" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(utils<span class="sc">::</span><span class="fu">head</span>(desc_lc, <span class="dv">10</span>))</span>
<span id="cb35-355"><a href="#cb35-355" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(utils<span class="sc">::</span><span class="fu">head</span>(asc_lc, <span class="dv">10</span>))</span>
<span id="cb35-356"><a href="#cb35-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-357"><a href="#cb35-357" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Frequency &amp; probability tables for Age, FS_IQ, Sex</span></span>
<span id="cb35-358"><a href="#cb35-358" aria-hidden="true" tabindex="-1"></a>freq_age  <span class="ot">&lt;-</span> <span class="fu">table</span>(schizo<span class="sc">$</span>age,  <span class="at">useNA =</span> <span class="st">"ifany"</span>)</span>
<span id="cb35-359"><a href="#cb35-359" aria-hidden="true" tabindex="-1"></a>freq_fsiq <span class="ot">&lt;-</span> <span class="fu">table</span>(schizo<span class="sc">$</span>fs_iq, <span class="at">useNA =</span> <span class="st">"ifany"</span>)</span>
<span id="cb35-360"><a href="#cb35-360" aria-hidden="true" tabindex="-1"></a>freq_sex  <span class="ot">&lt;-</span> <span class="fu">table</span>(schizo<span class="sc">$</span>sex,   <span class="at">useNA =</span> <span class="st">"ifany"</span>)</span>
<span id="cb35-361"><a href="#cb35-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-362"><a href="#cb35-362" aria-hidden="true" tabindex="-1"></a>prob_age  <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(freq_age)</span>
<span id="cb35-363"><a href="#cb35-363" aria-hidden="true" tabindex="-1"></a>prob_fsiq <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(freq_fsiq)</span>
<span id="cb35-364"><a href="#cb35-364" aria-hidden="true" tabindex="-1"></a>prob_sex  <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(freq_sex)</span>
<span id="cb35-365"><a href="#cb35-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-366"><a href="#cb35-366" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">list</span>(</span>
<span id="cb35-367"><a href="#cb35-367" aria-hidden="true" tabindex="-1"></a>  <span class="at">freq_age  =</span> <span class="fu">as.data.frame</span>(freq_age),</span>
<span id="cb35-368"><a href="#cb35-368" aria-hidden="true" tabindex="-1"></a>  <span class="at">freq_fsiq =</span> <span class="fu">as.data.frame</span>(freq_fsiq),</span>
<span id="cb35-369"><a href="#cb35-369" aria-hidden="true" tabindex="-1"></a>  <span class="at">freq_sex  =</span> <span class="fu">as.data.frame</span>(freq_sex),</span>
<span id="cb35-370"><a href="#cb35-370" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob_age  =</span> <span class="fu">as.data.frame</span>(prob_age),</span>
<span id="cb35-371"><a href="#cb35-371" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob_fsiq =</span> <span class="fu">as.data.frame</span>(prob_fsiq),</span>
<span id="cb35-372"><a href="#cb35-372" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob_sex  =</span> <span class="fu">as.data.frame</span>(prob_sex)</span>
<span id="cb35-373"><a href="#cb35-373" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb35-374"><a href="#cb35-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-375"><a href="#cb35-375" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Mean Age &amp; correlation(Age, FS_IQ)</span></span>
<span id="cb35-376"><a href="#cb35-376" aria-hidden="true" tabindex="-1"></a>mean_age <span class="ot">&lt;-</span> <span class="fu">mean</span>(schizo<span class="sc">$</span>age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-377"><a href="#cb35-377" aria-hidden="true" tabindex="-1"></a>corr_age_fsiq <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(stats<span class="sc">::</span><span class="fu">cor</span>(schizo<span class="sc">$</span>age, schizo<span class="sc">$</span>fs_iq, <span class="at">use =</span> <span class="st">"complete.obs"</span>))</span>
<span id="cb35-378"><a href="#cb35-378" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tibble<span class="sc">::</span><span class="fu">tibble</span>(mean_age, corr_age_fsiq))</span>
<span id="cb35-379"><a href="#cb35-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-380"><a href="#cb35-380" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Plots</span></span>
<span id="cb35-381"><a href="#cb35-381" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>))</span>
<span id="cb35-382"><a href="#cb35-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-383"><a href="#cb35-383" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram + density of R_fusiform_gyrus (if available)</span></span>
<span id="cb35-384"><a href="#cb35-384" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"r_fusiform_gyrus"</span> <span class="sc">%in%</span> <span class="fu">names</span>(schizo)) {</span>
<span id="cb35-385"><a href="#cb35-385" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(schizo, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> r_fusiform_gyrus)) <span class="sc">+</span></span>
<span id="cb35-386"><a href="#cb35-386" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_histogram</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb35-387"><a href="#cb35-387" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb35-388"><a href="#cb35-388" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"R_fusiform_gyrus: Histogram &amp; Density"</span>, <span class="at">x =</span> <span class="st">"R_fusiform_gyrus"</span>, <span class="at">y =</span> <span class="st">"Density"</span>)</span>
<span id="cb35-389"><a href="#cb35-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p1)</span>
<span id="cb35-390"><a href="#cb35-390" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb35-391"><a href="#cb35-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Column 'r_fusiform_gyrus' not found; skipping histogram+density plot."</span>)</span>
<span id="cb35-392"><a href="#cb35-392" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-393"><a href="#cb35-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-394"><a href="#cb35-394" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter: L_fusiform_gyrus vs L_insular_cortex (if both available)</span></span>
<span id="cb35-395"><a href="#cb35-395" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"l_fusiform_gyrus"</span>,<span class="st">"l_insular_cortex"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(schizo))) {</span>
<span id="cb35-396"><a href="#cb35-396" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(schizo, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> l_fusiform_gyrus, <span class="at">y =</span> l_insular_cortex)) <span class="sc">+</span></span>
<span id="cb35-397"><a href="#cb35-397" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb35-398"><a href="#cb35-398" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb35-399"><a href="#cb35-399" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"L_fusiform_gyrus vs L_insular_cortex"</span>, <span class="at">x =</span> <span class="st">"L_fusiform_gyrus"</span>, <span class="at">y =</span> <span class="st">"L_insular_cortex"</span>)</span>
<span id="cb35-400"><a href="#cb35-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p2)</span>
<span id="cb35-401"><a href="#cb35-401" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb35-402"><a href="#cb35-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Columns 'l_fusiform_gyrus' and/or 'l_insular_cortex' not found; skipping scatter plot."</span>)</span>
<span id="cb35-403"><a href="#cb35-403" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-404"><a href="#cb35-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-405"><a href="#cb35-405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-406"><a href="#cb35-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-409"><a href="#cb35-409" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-410"><a href="#cb35-410" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Problem 1.3: Simulation &amp; Q–Q (robust, base R) ----</span></span>
<span id="cb35-411"><a href="#cb35-411" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">506</span>)</span>
<span id="cb35-412"><a href="#cb35-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-413"><a href="#cb35-413" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate samples</span></span>
<span id="cb35-414"><a href="#cb35-414" aria-hidden="true" tabindex="-1"></a>x_norm <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10000</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb35-415"><a href="#cb35-415" aria-hidden="true" tabindex="-1"></a>y_t    <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rt</span>(<span class="dv">5000</span>, <span class="at">df =</span> <span class="dv">5</span>)</span>
<span id="cb35-416"><a href="#cb35-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-417"><a href="#cb35-417" aria-hidden="true" tabindex="-1"></a><span class="co"># Q–Q: empirical quantiles of N(0,1) vs t(5)</span></span>
<span id="cb35-418"><a href="#cb35-418" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">length</span>(x_norm), <span class="fu">length</span>(y_t))</span>
<span id="cb35-419"><a href="#cb35-419" aria-hidden="true" tabindex="-1"></a>probs <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">ppoints</span>(n)</span>
<span id="cb35-420"><a href="#cb35-420" aria-hidden="true" tabindex="-1"></a>qx <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">quantile</span>(x_norm, <span class="at">probs =</span> probs)</span>
<span id="cb35-421"><a href="#cb35-421" aria-hidden="true" tabindex="-1"></a>qy <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">quantile</span>(y_t,    <span class="at">probs =</span> probs)</span>
<span id="cb35-422"><a href="#cb35-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-423"><a href="#cb35-423" aria-hidden="true" tabindex="-1"></a>graphics<span class="sc">::</span><span class="fu">plot</span>(qx, qy,</span>
<span id="cb35-424"><a href="#cb35-424" aria-hidden="true" tabindex="-1"></a>               <span class="at">xlab =</span> <span class="st">"Quantiles of N(0,1) sample"</span>,</span>
<span id="cb35-425"><a href="#cb35-425" aria-hidden="true" tabindex="-1"></a>               <span class="at">ylab =</span> <span class="st">"Quantiles of t(df=5) sample"</span>,</span>
<span id="cb35-426"><a href="#cb35-426" aria-hidden="true" tabindex="-1"></a>               <span class="at">main =</span> <span class="st">"Q–Q: Normal vs Student t (df = 5)"</span>,</span>
<span id="cb35-427"><a href="#cb35-427" aria-hidden="true" tabindex="-1"></a>               <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb35-428"><a href="#cb35-428" aria-hidden="true" tabindex="-1"></a>graphics<span class="sc">::</span><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb35-429"><a href="#cb35-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-430"><a href="#cb35-430" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare with qqnorm() for the t sample</span></span>
<span id="cb35-431"><a href="#cb35-431" aria-hidden="true" tabindex="-1"></a>stats<span class="sc">::</span><span class="fu">qqnorm</span>(y_t, <span class="at">main =</span> <span class="st">"qqnorm(): t(df=5) sample"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb35-432"><a href="#cb35-432" aria-hidden="true" tabindex="-1"></a>stats<span class="sc">::</span><span class="fu">qqline</span>(y_t, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb35-433"><a href="#cb35-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-434"><a href="#cb35-434" aria-hidden="true" tabindex="-1"></a><span class="co"># (Optional) Interactive qqnorm with plotly if available; otherwise silently skip</span></span>
<span id="cb35-435"><a href="#cb35-435" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"plotly"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb35-436"><a href="#cb35-436" aria-hidden="true" tabindex="-1"></a>  theo <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">qnorm</span>(stats<span class="sc">::</span><span class="fu">ppoints</span>(<span class="fu">length</span>(y_t)))</span>
<span id="cb35-437"><a href="#cb35-437" aria-hidden="true" tabindex="-1"></a>  emp  <span class="ot">&lt;-</span> <span class="fu">sort</span>(y_t)</span>
<span id="cb35-438"><a href="#cb35-438" aria-hidden="true" tabindex="-1"></a>  plt <span class="ot">&lt;-</span> plotly<span class="sc">::</span><span class="fu">plot_ly</span>(<span class="at">x =</span> theo, <span class="at">y =</span> emp, <span class="at">type =</span> <span class="st">"scatter"</span>, <span class="at">mode =</span> <span class="st">"markers"</span>)</span>
<span id="cb35-439"><a href="#cb35-439" aria-hidden="true" tabindex="-1"></a>  plt <span class="ot">&lt;-</span> plotly<span class="sc">::</span><span class="fu">layout</span>(plt,</span>
<span id="cb35-440"><a href="#cb35-440" aria-hidden="true" tabindex="-1"></a>                        <span class="at">title =</span> <span class="st">"Interactive qqnorm: t(df=5)"</span>,</span>
<span id="cb35-441"><a href="#cb35-441" aria-hidden="true" tabindex="-1"></a>                        <span class="at">xaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Theoretical Normal Quantiles"</span>),</span>
<span id="cb35-442"><a href="#cb35-442" aria-hidden="true" tabindex="-1"></a>                        <span class="at">yaxis =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Sample Quantiles (t, df=5)"</span>))</span>
<span id="cb35-443"><a href="#cb35-443" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(<span class="fu">print</span>(plt))</span>
<span id="cb35-444"><a href="#cb35-444" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-445"><a href="#cb35-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-446"><a href="#cb35-446" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Interpretation:</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb35-447"><a href="#cb35-447" aria-hidden="true" tabindex="-1"></a>    <span class="st">"- t(df=5) has heavier tails than N(0,1): points deviate from the 45° line in both tails.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb35-448"><a href="#cb35-448" aria-hidden="true" tabindex="-1"></a>    <span class="st">"- qqnorm(y_t) likewise bows in the tails, showing excess kurtosis vs. normal.</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb35-449"><a href="#cb35-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-450"><a href="#cb35-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-451"><a href="#cb35-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-454"><a href="#cb35-454" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-455"><a href="#cb35-455" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Problem 1.4: Robust myMode() (pure base R) ----</span></span>
<span id="cb35-456"><a href="#cb35-456" aria-hidden="true" tabindex="-1"></a>myMode <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb35-457"><a href="#cb35-457" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute mode for an atomic vector (numeric/character/logical)</span></span>
<span id="cb35-458"><a href="#cb35-458" aria-hidden="true" tabindex="-1"></a>  .mode_atomic <span class="ot">&lt;-</span> <span class="cf">function</span>(v) {</span>
<span id="cb35-459"><a href="#cb35-459" aria-hidden="true" tabindex="-1"></a>    v_no_na <span class="ot">&lt;-</span> v[<span class="sc">!</span><span class="fu">is.na</span>(v)]</span>
<span id="cb35-460"><a href="#cb35-460" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(v_no_na)) {</span>
<span id="cb35-461"><a href="#cb35-461" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">modes =</span> <span class="cn">NA</span>, <span class="at">count =</span> <span class="dv">0</span>L, <span class="at">ties =</span> <span class="cn">FALSE</span>, <span class="at">total_n =</span> <span class="fu">length</span>(v), <span class="at">unique_n =</span> <span class="dv">0</span>L))</span>
<span id="cb35-462"><a href="#cb35-462" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-463"><a href="#cb35-463" aria-hidden="true" tabindex="-1"></a>    tab <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">table</span>(v_no_na, <span class="at">useNA =</span> <span class="st">"no"</span>)</span>
<span id="cb35-464"><a href="#cb35-464" aria-hidden="true" tabindex="-1"></a>    maxc <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">max</span>(tab)</span>
<span id="cb35-465"><a href="#cb35-465" aria-hidden="true" tabindex="-1"></a>    modes_chr <span class="ot">&lt;-</span> <span class="fu">names</span>(tab)[tab <span class="sc">==</span> maxc]</span>
<span id="cb35-466"><a href="#cb35-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-467"><a href="#cb35-467" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try casting modes back to numeric if the data are numeric-like</span></span>
<span id="cb35-468"><a href="#cb35-468" aria-hidden="true" tabindex="-1"></a>    cast_back <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(modes_chr))</span>
<span id="cb35-469"><a href="#cb35-469" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.numeric</span>(v_no_na) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(cast_back))) {</span>
<span id="cb35-470"><a href="#cb35-470" aria-hidden="true" tabindex="-1"></a>      modes_val <span class="ot">&lt;-</span> cast_back</span>
<span id="cb35-471"><a href="#cb35-471" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb35-472"><a href="#cb35-472" aria-hidden="true" tabindex="-1"></a>      modes_val <span class="ot">&lt;-</span> modes_chr</span>
<span id="cb35-473"><a href="#cb35-473" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-474"><a href="#cb35-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-475"><a href="#cb35-475" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb35-476"><a href="#cb35-476" aria-hidden="true" tabindex="-1"></a>      <span class="at">modes    =</span> modes_val,</span>
<span id="cb35-477"><a href="#cb35-477" aria-hidden="true" tabindex="-1"></a>      <span class="at">count    =</span> <span class="fu">as.integer</span>(maxc),</span>
<span id="cb35-478"><a href="#cb35-478" aria-hidden="true" tabindex="-1"></a>      <span class="at">ties     =</span> <span class="fu">length</span>(modes_val) <span class="sc">&gt;</span> <span class="dv">1</span>,</span>
<span id="cb35-479"><a href="#cb35-479" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_n  =</span> <span class="fu">length</span>(v),</span>
<span id="cb35-480"><a href="#cb35-480" aria-hidden="true" tabindex="-1"></a>      <span class="at">unique_n =</span> <span class="fu">length</span>(tab)</span>
<span id="cb35-481"><a href="#cb35-481" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-482"><a href="#cb35-482" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-483"><a href="#cb35-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-484"><a href="#cb35-484" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data frame: column-wise</span></span>
<span id="cb35-485"><a href="#cb35-485" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.data.frame</span>(x)) <span class="fu">return</span>(<span class="fu">lapply</span>(x, myMode))</span>
<span id="cb35-486"><a href="#cb35-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-487"><a href="#cb35-487" aria-hidden="true" tabindex="-1"></a>  <span class="co"># General list (non-atomic): element-wise</span></span>
<span id="cb35-488"><a href="#cb35-488" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.list</span>(x) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.atomic</span>(x)) <span class="fu">return</span>(<span class="fu">lapply</span>(x, myMode))</span>
<span id="cb35-489"><a href="#cb35-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-490"><a href="#cb35-490" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Arrays / matrices: flatten then compute</span></span>
<span id="cb35-491"><a href="#cb35-491" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.array</span>(x) <span class="sc">||</span> <span class="fu">is.matrix</span>(x)) <span class="fu">return</span>(<span class="fu">.mode_atomic</span>(<span class="fu">as.vector</span>(x)))</span>
<span id="cb35-492"><a href="#cb35-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-493"><a href="#cb35-493" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Factors -&gt; character; dates/times -&gt; numeric</span></span>
<span id="cb35-494"><a href="#cb35-494" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(x)) x <span class="ot">&lt;-</span> <span class="fu">as.character</span>(x)</span>
<span id="cb35-495"><a href="#cb35-495" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(x, <span class="st">"Date"</span>) <span class="sc">||</span> <span class="fu">inherits</span>(x, <span class="st">"POSIXct"</span>) <span class="sc">||</span> <span class="fu">inherits</span>(x, <span class="st">"POSIXt"</span>)) x <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(x)</span>
<span id="cb35-496"><a href="#cb35-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-497"><a href="#cb35-497" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Atomic vectors</span></span>
<span id="cb35-498"><a href="#cb35-498" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.atomic</span>(x)) <span class="fu">return</span>(<span class="fu">.mode_atomic</span>(x))</span>
<span id="cb35-499"><a href="#cb35-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-500"><a href="#cb35-500" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fallback</span></span>
<span id="cb35-501"><a href="#cb35-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">modes =</span> <span class="cn">NA</span>, <span class="at">count =</span> <span class="cn">NA_integer_</span>, <span class="at">ties =</span> <span class="cn">NA</span>, <span class="at">total_n =</span> <span class="fu">length</span>(x), <span class="at">unique_n =</span> <span class="cn">NA_integer_</span>)</span>
<span id="cb35-502"><a href="#cb35-502" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-503"><a href="#cb35-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-504"><a href="#cb35-504" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Quick tests (self-contained) ----</span></span>
<span id="cb35-505"><a href="#cb35-505" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate samples</span></span>
<span id="cb35-506"><a href="#cb35-506" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">507</span>)</span>
<span id="cb35-507"><a href="#cb35-507" aria-hidden="true" tabindex="-1"></a>x_norm <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="dv">10000</span>)</span>
<span id="cb35-508"><a href="#cb35-508" aria-hidden="true" tabindex="-1"></a>y_t    <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rt</span>(<span class="dv">5000</span>, <span class="at">df =</span> <span class="dv">5</span>)</span>
<span id="cb35-509"><a href="#cb35-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-510"><a href="#cb35-510" aria-hidden="true" tabindex="-1"></a>mode_norm <span class="ot">&lt;-</span> <span class="fu">myMode</span>(x_norm)  <span class="co"># for continuous data, ties likely (many singletons)</span></span>
<span id="cb35-511"><a href="#cb35-511" aria-hidden="true" tabindex="-1"></a>mode_t    <span class="ot">&lt;-</span> <span class="fu">myMode</span>(y_t)</span>
<span id="cb35-512"><a href="#cb35-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-513"><a href="#cb35-513" aria-hidden="true" tabindex="-1"></a>char_vec  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"a"</span>,<span class="st">"b"</span>,<span class="st">"a"</span>,<span class="st">"c"</span>,<span class="st">"b"</span>,<span class="st">"a"</span>, <span class="cn">NA</span>, <span class="st">"c"</span>)</span>
<span id="cb35-514"><a href="#cb35-514" aria-hidden="true" tabindex="-1"></a>mode_char <span class="ot">&lt;-</span> <span class="fu">myMode</span>(char_vec)</span>
<span id="cb35-515"><a href="#cb35-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-516"><a href="#cb35-516" aria-hidden="true" tabindex="-1"></a>arr <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="cn">NA</span>,<span class="dv">4</span>), <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb35-517"><a href="#cb35-517" aria-hidden="true" tabindex="-1"></a>mode_arr <span class="ot">&lt;-</span> <span class="fu">myMode</span>(arr)</span>
<span id="cb35-518"><a href="#cb35-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-519"><a href="#cb35-519" aria-hidden="true" tabindex="-1"></a>df_mixed <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb35-520"><a href="#cb35-520" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="cn">NA</span>),</span>
<span id="cb35-521"><a href="#cb35-521" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"x"</span>,<span class="st">"z"</span>,<span class="st">"x"</span>,<span class="cn">NA</span>,<span class="st">"x"</span>),</span>
<span id="cb35-522"><a href="#cb35-522" aria-hidden="true" tabindex="-1"></a>  <span class="at">c =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"lo"</span>,<span class="st">"lo"</span>,<span class="st">"hi"</span>,<span class="st">"lo"</span>,<span class="st">"hi"</span>,<span class="st">"hi"</span>,<span class="st">"hi"</span>)),</span>
<span id="cb35-523"><a href="#cb35-523" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb35-524"><a href="#cb35-524" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-525"><a href="#cb35-525" aria-hidden="true" tabindex="-1"></a>mode_df <span class="ot">&lt;-</span> <span class="fu">myMode</span>(df_mixed)</span>
<span id="cb35-526"><a href="#cb35-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-527"><a href="#cb35-527" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"myMode(x_norm): count ="</span>, mode_norm<span class="sc">$</span>count, <span class="st">" ties ="</span>, mode_norm<span class="sc">$</span>ties, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-528"><a href="#cb35-528" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"myMode(y_t):    count ="</span>, mode_t<span class="sc">$</span>count,    <span class="st">" ties ="</span>, mode_t<span class="sc">$</span>ties,    <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-529"><a href="#cb35-529" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"myMode(char):   modes ="</span>, <span class="fu">paste</span>(mode_char<span class="sc">$</span>modes, <span class="at">collapse =</span> <span class="st">","</span>),</span>
<span id="cb35-530"><a href="#cb35-530" aria-hidden="true" tabindex="-1"></a>    <span class="st">" count ="</span>, mode_char<span class="sc">$</span>count, <span class="st">" ties ="</span>, mode_char<span class="sc">$</span>ties, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-531"><a href="#cb35-531" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"myMode(array):  modes ="</span>, <span class="fu">paste</span>(mode_arr<span class="sc">$</span>modes, <span class="at">collapse =</span> <span class="st">","</span>),</span>
<span id="cb35-532"><a href="#cb35-532" aria-hidden="true" tabindex="-1"></a>    <span class="st">" count ="</span>, mode_arr<span class="sc">$</span>count,  <span class="st">" ties ="</span>, mode_arr<span class="sc">$</span>ties,  <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-533"><a href="#cb35-533" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"myMode(df):     per-column results below.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-534"><a href="#cb35-534" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mode_df)</span>
<span id="cb35-535"><a href="#cb35-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-536"><a href="#cb35-536" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>